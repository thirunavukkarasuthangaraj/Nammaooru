version: '3.8'

services:
  # Spring Boot Backend (PostgreSQL is external - not in Docker)
  backend:
    build:
      context: ./backend
      # Limit build memory so it doesn't kill running app
      args:
        - MAVEN_OPTS=-Xmx512m
    # REMOVED container_name to allow multiple instances
    # Limit runtime CPU/memory
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 512M
    environment:
      # JVM memory limits (prevent swap on 4GB server)
      - JAVA_OPTS=-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxMetaspaceSize=128m
      # Database configuration
      - DB_URL=${DB_URL:-jdbc:postgresql://host.docker.internal:5432/shop_management_db}
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      # JWT secret (REQUIRED in production)
      - JWT_SECRET=${JWT_SECRET:-your-jwt-secret-key-here}
      # File upload paths - use CONTAINER paths (/app/uploads), NOT host paths
      # Host path /opt/shop-management/uploads is mounted to container path /app/uploads
      - FILE_UPLOAD_PATH=${FILE_UPLOAD_PATH:-/app/uploads}
      - APP_UPLOAD_DIR=${APP_UPLOAD_DIR:-/app/uploads}
      - DOCUMENT_UPLOAD_PATH=${DOCUMENT_UPLOAD_PATH:-/app/uploads/documents/shops}
      - DELIVERY_PARTNER_DOCUMENT_PATH=${DELIVERY_PARTNER_DOCUMENT_PATH:-/app/uploads/documents/delivery-partners}
      - PRODUCT_IMAGES_PATH=${PRODUCT_IMAGES_PATH:-/app/uploads/products}
      # JPA configuration (for development, use: JPA_DDL_AUTO=update JPA_SHOW_SQL=true)
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-update}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      # Scheduled jobs control (for zero-downtime deployment)
      - APP_SCHEDULING_ENABLED=${APP_SCHEDULING_ENABLED:-true}
      # Firebase configuration path (mounted from host)
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/firebase-config/firebase-service-account.json
      # SMTP / Email
      - MAIL_HOST=${MAIL_HOST:-smtp.hostinger.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME:-noreplay@nammaoorudelivary.in}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      # Razorpay Payment Gateway
      - RAZORPAY_MODE=${RAZORPAY_MODE:-test}
      - RAZORPAY_TEST_KEY_ID=${RAZORPAY_TEST_KEY_ID}
      - RAZORPAY_TEST_KEY_SECRET=${RAZORPAY_TEST_KEY_SECRET}
      - RAZORPAY_LIVE_KEY_ID=${RAZORPAY_LIVE_KEY_ID}
      - RAZORPAY_LIVE_KEY_SECRET=${RAZORPAY_LIVE_KEY_SECRET}
      # MSG91 SMS/WhatsApp
      - MSG91_AUTH_KEY=${MSG91_AUTH_KEY}
      - MSG91_SENDER_ID=${MSG91_SENDER_ID:-NAMMAO}
      - MSG91_OTP_TEMPLATE_ID=${MSG91_OTP_TEMPLATE_ID}
      - MSG91_NAMESPACE=${MSG91_NAMESPACE}
      - MSG91_INTEGRATED_NUMBER=${MSG91_INTEGRATED_NUMBER}
      # Gemini AI API Keys
      - GEMINI_ENABLED=${GEMINI_ENABLED:-true}
      - GEMINI_API_KEY_1=${GEMINI_API_KEY_1}
      - GEMINI_API_KEY_2=${GEMINI_API_KEY_2}
      - GEMINI_API_KEY_3=${GEMINI_API_KEY_3}
      - GEMINI_API_KEY_4=${GEMINI_API_KEY_4}
    # Expose internal port - Docker assigns random host port
    # Deploy script detects port dynamically and updates Nginx
    ports:
      - "8080"
    volumes:
      # Mount host directory for persistent file storage (production)
      - /mnt/HC_Volume_104749884:/app/uploads
      # Mount firebase-config directory (read-only for security)
      - ./firebase-config:/app/firebase-config:ro
    networks:
      - shop-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    # Allow scaling
    labels:
      - "com.shop.service=backend"

  # Angular Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # REMOVED container_name to allow multiple instances
    expose:
      - "80"
    ports:
      - "8080-8085:80"
    networks:
      - shop-network
    depends_on:
      - backend
    restart: unless-stopped
    labels:
      - "com.shop.service=frontend"

networks:
  shop-network:
    driver: bridge
