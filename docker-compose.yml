version: '3.8'

services:
  # Spring Boot Backend (PostgreSQL is external - not in Docker)
  backend:
    build:
      context: ./backend
    # REMOVED container_name to allow multiple instances
    environment:
      # JVM memory limits (prevent swap on 4GB server)
      - JAVA_OPTS=-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxMetaspaceSize=128m
      # Database configuration
      - DB_URL=${DB_URL:-jdbc:postgresql://host.docker.internal:5432/shop_management_db}
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      # JWT secret (REQUIRED in production)
      - JWT_SECRET=${JWT_SECRET:-your-jwt-secret-key-here}
      # File upload paths - use CONTAINER paths (/app/uploads), NOT host paths
      # Host path /opt/shop-management/uploads is mounted to container path /app/uploads
      - FILE_UPLOAD_PATH=${FILE_UPLOAD_PATH:-/app/uploads}
      - APP_UPLOAD_DIR=${APP_UPLOAD_DIR:-/app/uploads}
      - DOCUMENT_UPLOAD_PATH=${DOCUMENT_UPLOAD_PATH:-/app/uploads/documents/shops}
      - DELIVERY_PARTNER_DOCUMENT_PATH=${DELIVERY_PARTNER_DOCUMENT_PATH:-/app/uploads/documents/delivery-partners}
      - PRODUCT_IMAGES_PATH=${PRODUCT_IMAGES_PATH:-/app/uploads/products}
      # JPA configuration (for development, use: JPA_DDL_AUTO=update JPA_SHOW_SQL=true)
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      # Scheduled jobs control (for zero-downtime deployment)
      - APP_SCHEDULING_ENABLED=${APP_SCHEDULING_ENABLED:-true}
      # Firebase configuration path (mounted from host)
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/firebase-config/firebase-service-account.json
    # Expose internal port only (Nginx will proxy to these)
    # Docker will automatically assign available host ports
    # Deployment script discovers actual ports dynamically
    ports:
      - "8080"  # Format: "internal_port" - Docker assigns random host port
    volumes:
      # Mount host directory for persistent file storage (production)
      - /opt/shop-management/uploads:/app/uploads
      # Mount firebase-config directory (read-only for security)
      - ./firebase-config:/app/firebase-config:ro
    networks:
      - shop-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    # Allow scaling
    labels:
      - "com.shop.service=backend"

  # Angular Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # REMOVED container_name to allow multiple instances
    expose:
      - "80"
    ports:
      - "8080-8085:80"
    networks:
      - shop-network
    depends_on:
      - backend
    restart: unless-stopped
    labels:
      - "com.shop.service=frontend"

networks:
  shop-network:
    driver: bridge
