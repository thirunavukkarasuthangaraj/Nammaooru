"use strict";(self.webpackChunkshop_management_frontend=self.webpackChunkshop_management_frontend||[]).push([[259],{1259:(k,q,I)=>{I.d(q,{m:()=>j});var l=I(467),x=I(7705);const m="products",S="offlineOrders",P="offlineEdits",h="offlineProductCreations",g="syncMeta",B="ordersCache",C="dashboardCache",D="combosCache",_="imageCache";let j=(()=>{class A{constructor(){this.db=null,this.dbReady=this.initializeDB()}initializeDB(){return new Promise((r,n)=>{const d=setTimeout(()=>{console.error("IndexedDB initialization timed out"),n(new Error("IndexedDB initialization timed out"))},5e3);try{const i=indexedDB.open("NammaOoruPOS",7);i.onerror=()=>{clearTimeout(d),console.error("Failed to open IndexedDB:",i.error),n(i.error)},i.onsuccess=()=>{clearTimeout(d),this.db=i.result,console.log("IndexedDB initialized successfully"),r(this.db)},i.onupgradeneeded=t=>{const o=t.target.result,s=t.oldVersion;if(o.objectStoreNames.contains(m)){if(s<4){const c=t.target.transaction.objectStore(m);c.indexNames.contains("barcode1")||c.createIndex("barcode1","barcode1",{unique:!1}),c.indexNames.contains("barcode2")||c.createIndex("barcode2","barcode2",{unique:!1}),c.indexNames.contains("barcode3")||c.createIndex("barcode3","barcode3",{unique:!1})}}else{const e=o.createObjectStore(m,{keyPath:"id"});e.createIndex("barcode","barcode",{unique:!1}),e.createIndex("sku","sku",{unique:!1}),e.createIndex("name","name",{unique:!1}),e.createIndex("barcode1","barcode1",{unique:!1}),e.createIndex("barcode2","barcode2",{unique:!1}),e.createIndex("barcode3","barcode3",{unique:!1})}if(!o.objectStoreNames.contains(S)){const e=o.createObjectStore(S,{keyPath:"offlineOrderId"});e.createIndex("synced","synced",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!o.objectStoreNames.contains(P)){const e=o.createObjectStore(P,{keyPath:"editId"});e.createIndex("productId","productId",{unique:!1}),e.createIndex("synced","synced",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!o.objectStoreNames.contains(h)){const e=o.createObjectStore(h,{keyPath:"offlineProductId"});e.createIndex("shopId","shopId",{unique:!1}),e.createIndex("synced","synced",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("barcode1","barcode1",{unique:!1})}if(o.objectStoreNames.contains(g)||o.createObjectStore(g,{keyPath:"key"}),!o.objectStoreNames.contains(B)){const e=o.createObjectStore(B,{keyPath:"id"});e.createIndex("shopId","shopId",{unique:!1}),e.createIndex("status","status",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("orderNumber","orderNumber",{unique:!1})}o.objectStoreNames.contains(C)||o.createObjectStore(C,{keyPath:"key"}),o.objectStoreNames.contains(D)||o.createObjectStore(D,{keyPath:"id"}).createIndex("shopId","shopId",{unique:!1}),o.objectStoreNames.contains(_)||o.createObjectStore(_,{keyPath:"url"}).createIndex("cachedAt","cachedAt",{unique:!1})}}catch(i){clearTimeout(d),console.error("IndexedDB not available:",i),n(i)}})}getDB(){var r=this;return(0,l.A)(function*(){if(r.db)try{if(r.db.objectStoreNames.length>0)return r.db}catch{console.warn("IndexedDB connection closed, reopening..."),r.db=null}return r.db||(r.dbReady=r.initializeDB()),r.dbReady})()}saveProducts(r,n){var d=this;return(0,l.A)(function*(){const t=(yield d.getDB()).transaction([m,g],"readwrite"),o=t.objectStore(m),s=t.objectStore(g);yield d.clearStore(o);for(const e of r)o.put(e);return s.put({key:`products_sync_${n}`,timestamp:(new Date).toISOString(),count:r.length}),new Promise((e,c)=>{t.oncomplete=()=>{console.log(`Cached ${r.length} products for shop ${n}`),e()},t.onerror=()=>c(t.error)})})()}addProductToCache(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(m,"readwrite").objectStore(m);return new Promise((o,s)=>{const e=t.put(r);e.onsuccess=()=>{console.log("Product added to cache:",r.id),o()},e.onerror=()=>s(e.error)})})()}removeProductFromCache(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(m,"readwrite").objectStore(m);return new Promise((o,s)=>{const e=t.delete(r);e.onsuccess=()=>{console.log("Product removed from cache:",r),o()},e.onerror=()=>s(e.error)})})()}getProducts(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(m,"readonly").objectStore(m);return new Promise((t,o)=>{const s=i.getAll();s.onsuccess=()=>t(s.result||[]),s.onerror=()=>o(s.error)})})()}getProductCount(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(m,"readonly").objectStore(m);return new Promise((t,o)=>{const s=i.count();s.onsuccess=()=>t(s.result),s.onerror=()=>o(s.error)})})()}getProductsPage(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(m,"readonly").objectStore(m),s=yield new Promise((a,u)=>{const b=o.count();b.onsuccess=()=>a(b.result),b.onerror=()=>u(b.error)}),e=r*n,c=[];return new Promise((a,u)=>{let b=0;const f=o.openCursor();f.onsuccess=w=>{const y=w.target.result;y?b<e?(b++,y.continue()):c.length<n?(c.push(y.value),y.continue()):a({products:c,total:s}):a({products:c,total:s})},f.onerror=()=>u(f.error)})})()}findByBarcode(r){var n=this;return(0,l.A)(function*(){if(!r||""===r.trim())return null;const t=(yield n.getDB()).transaction(m,"readonly").objectStore(m),o=r.trim(),s=["barcode","barcode1","barcode2","barcode3","sku"];return new Promise((e,c)=>{let a=!1,u=0;for(const b of s){if(!t.indexNames.contains(b)){u++,u===s.length&&!a&&e(null);continue}const w=t.index(b).get(o);w.onsuccess=()=>{!a&&w.result?(a=!0,e(w.result)):(u++,u===s.length&&!a&&e(null))},w.onerror=()=>{u++,u===s.length&&!a&&e(null)}}})})()}findBySku(r){var n=this;return(0,l.A)(function*(){const o=(yield n.getDB()).transaction(m,"readonly").objectStore(m).index("sku");return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>s(c.result||null),c.onerror=()=>e(c.error)})})()}searchProducts(r){var n=this;return(0,l.A)(function*(d,i=50){if(!d||""===d.trim())return[];const t=d.toLowerCase().trim(),o=yield n.findByBarcode(d.trim());if(o)return[o];const c=(yield n.getDB()).transaction(m,"readonly").objectStore(m);return new Promise((a,u)=>{const b=[],f=c.openCursor();f.onsuccess=w=>{const y=w.target.result;if(y&&b.length<i){const p=y.value;(p.name.toLowerCase().includes(t)||p.nameTamil&&p.nameTamil.toLowerCase().includes(t)||p.sku&&p.sku.toLowerCase().includes(t)||p.barcode&&p.barcode.toLowerCase().includes(t)||p.barcode1&&p.barcode1.toLowerCase().includes(t)||p.barcode2&&p.barcode2.toLowerCase().includes(t)||p.barcode3&&p.barcode3.toLowerCase().includes(t))&&b.push(p),y.continue()}else a(b)},f.onerror=()=>u(f.error)})}).apply(this,arguments)}getProductsSyncTime(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(g,"readonly").objectStore(g);return new Promise((o,s)=>{const e=t.get(`products_sync_${r}`);e.onsuccess=()=>{const c=e.result;o(c?new Date(c.timestamp):null)},e.onerror=()=>s(e.error)})})()}saveOfflineOrder(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(S,"readwrite").objectStore(S);return new Promise((o,s)=>{const e=t.put(r);e.onsuccess=()=>{console.log("Offline order saved:",r.offlineOrderId),o()},e.onerror=()=>s(e.error)})})()}getPendingOrders(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(S,"readonly").objectStore(S);return new Promise((t,o)=>{const s=[],e=i.openCursor();e.onsuccess=c=>{const a=c.target.result;if(a){const u=a.value;!1===u.synced&&s.push(u),a.continue()}else t(s)},e.onerror=()=>o(e.error)})})()}getAllOfflineOrders(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(S,"readonly").objectStore(S);return new Promise((t,o)=>{const s=i.getAll();s.onsuccess=()=>t(s.result||[]),s.onerror=()=>o(s.error)})})()}markOrderSynced(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(S,"readwrite").objectStore(S);return new Promise((o,s)=>{const e=t.get(r);e.onsuccess=()=>{const c=e.result;if(c){c.synced=!0;const a=t.put(c);a.onsuccess=()=>o(),a.onerror=()=>s(a.error)}else o()},e.onerror=()=>s(e.error)})})()}removeOfflineOrder(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(S,"readwrite").objectStore(S);return new Promise((o,s)=>{const e=t.delete(r);e.onsuccess=()=>o(),e.onerror=()=>s(e.error)})})()}getPendingOrdersCount(){var r=this;return(0,l.A)(function*(){return(yield r.getPendingOrders()).length})()}saveOfflineEdit(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(P,"readwrite").objectStore(P);return new Promise((o,s)=>{const e=t.put(r);e.onsuccess=()=>{console.log("Offline edit saved:",r.editId),o()},e.onerror=()=>s(e.error)})})()}getPendingEdits(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(P,"readonly").objectStore(P);return new Promise((t,o)=>{const s=[],e=i.openCursor();e.onsuccess=c=>{const a=c.target.result;if(a){const u=a.value;!1===u.synced&&s.push(u),a.continue()}else t(s)},e.onerror=()=>o(e.error)})})()}getAllOfflineEdits(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(P,"readonly").objectStore(P);return new Promise((t,o)=>{const s=i.getAll();s.onsuccess=()=>t(s.result||[]),s.onerror=()=>o(s.error)})})()}markEditSynced(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(P,"readwrite").objectStore(P);return new Promise((o,s)=>{const e=t.get(r);e.onsuccess=()=>{const c=e.result;if(c){c.synced=!0;const a=t.put(c);a.onsuccess=()=>o(),a.onerror=()=>s(a.error)}else o()},e.onerror=()=>s(e.error)})})()}removeOfflineEdit(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(P,"readwrite").objectStore(P);return new Promise((o,s)=>{const e=t.delete(r);e.onsuccess=()=>o(),e.onerror=()=>s(e.error)})})()}getPendingEditsCount(){var r=this;return(0,l.A)(function*(){return(yield r.getPendingEdits()).length})()}updateLocalProduct(r,n){var d=this;return(0,l.A)(function*(i,t,o=0){try{const e=(yield d.getDB()).transaction(m,"readwrite"),c=e.objectStore(m);return yield new Promise((a,u)=>{const b=c.get(i);b.onsuccess=()=>{const f=b.result;if(f){void 0!==t.price&&(f.price=t.price),void 0!==t.originalPrice&&(f.originalPrice=t.originalPrice),void 0!==t.costPrice&&(f.costPrice=t.costPrice),void 0!==t.stock&&(f.stock=t.stock),void 0!==t.sku&&(f.sku=t.sku),void 0!==t.barcode&&(f.barcode=t.barcode),void 0!==t.barcode1&&(f.barcode1=t.barcode1),void 0!==t.barcode2&&(f.barcode2=t.barcode2),void 0!==t.barcode3&&(f.barcode3=t.barcode3),void 0!==t.name&&(f.name=t.name),void 0!==t.nameTamil&&(f.nameTamil=t.nameTamil),void 0!==t.imageBase64&&(f.imageBase64=t.imageBase64),void 0!==t.netQty&&(f.netQty=t.netQty),void 0!==t.packedDate&&(f.packedDate=t.packedDate),void 0!==t.expiryDate&&(f.expiryDate=t.expiryDate),void 0!==t.isAvailable&&(f.isAvailable=t.isAvailable);const w=c.put(f);w.onsuccess=()=>{console.log("Local product updated:",i),a()},w.onerror=()=>u(w.error)}else a()},b.onerror=()=>u(b.error),e.onerror=()=>u(e.error)})}catch(s){if(o<1&&s?.message?.includes("closing"))return console.warn("IndexedDB connection error, retrying...",s),d.db=null,d.updateLocalProduct(i,t,o+1);throw s}}).apply(this,arguments)}generateOfflineEditId(){return`EDIT-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}isOnline(){return navigator.onLine}clearStore(r){return new Promise((n,d)=>{const i=r.clear();i.onsuccess=()=>n(),i.onerror=()=>d(i.error)})}generateOfflineOrderId(){const r=new Date,i=`${r.getDate().toString().padStart(2,"0")}${(r.getMonth()+1).toString().padStart(2,"0")}`,t=`pos_order_counter_${i}`;let o=parseInt(localStorage.getItem(t)||"0",10);return o++,localStorage.setItem(t,o.toString()),`POS-${i}-${o.toString().padStart(3,"0")}`}updateLocalStock(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(m,"readwrite").objectStore(m);return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>{const a=c.result;if(a&&a.trackInventory){a.stock=Math.max(0,a.stock-n);const u=o.put(a);u.onsuccess=()=>s(),u.onerror=()=>e(u.error)}else s()},c.onerror=()=>e(c.error)})})()}generateOfflineProductId(){return`OFFPROD-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}generateTempProductId(){return-Math.floor(Date.now()+1e3*Math.random())}isBarcodeExists(r,n){var d=this;return(0,l.A)(function*(){if(!r||""===r.trim())return!1;const i=r.trim();return!!(yield d.findProductByBarcodeExcluding(i,n))||(yield d.isBarcodeInPendingCreations(i,n))})()}findProductByBarcodeExcluding(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(m,"readonly").objectStore(m),e=(r.toLowerCase(),["barcode","barcode1","barcode2","barcode3","sku"]);for(const c of e)if(o.indexNames.contains(c)&&(yield new Promise(u=>{const f=o.index(c).openCursor(IDBKeyRange.only(r));f.onsuccess=w=>{const y=w.target.result;if(y){if(!n||Number(y.value.id)!==Number(n))return void u(!0);y.continue()}else u(!1)},f.onerror=()=>u(!1)})))return!0;return!1})()}isBarcodeInPendingCreations(r,n){var d=this;return(0,l.A)(function*(){const t=(yield d.getDB()).transaction([h,m],"readonly"),o=t.objectStore(h),s=r.toLowerCase();let e=[];if(n){const c=t.objectStore(m),a=yield new Promise(u=>{const b=c.get(n);b.onsuccess=()=>u(b.result||null),b.onerror=()=>u(null)});a&&(e=[a.barcode1,a.barcode2,a.barcode3].filter(u=>u).map(u=>u.toLowerCase()))}return new Promise(c=>{const a=o.openCursor();a.onsuccess=u=>{const b=u.target.result;if(b){const f=b.value;if(f.synced)return void b.continue();if(e.length>0&&[f.barcode1,f.barcode2,f.barcode3].filter(y=>y).map(y=>y.toLowerCase()).some(y=>e.includes(y)))return void b.continue();if(f.sku&&f.sku.toLowerCase()===s||f.barcode1&&f.barcode1.toLowerCase()===s||f.barcode2&&f.barcode2.toLowerCase()===s||f.barcode3&&f.barcode3.toLowerCase()===s)return void c(!0);b.continue()}else c(!1)},a.onerror=()=>c(!1)})})()}validateBarcodes(r,n,d,i){var t=this;return(0,l.A)(function*(){const o=r?.trim()||null,s=n?.trim()||null,e=d?.trim()||null;return o&&s&&o.toLowerCase()===s.toLowerCase()?"Barcode 1 and Barcode 2 cannot be the same.":o&&e&&o.toLowerCase()===e.toLowerCase()?"Barcode 1 and Barcode 3 cannot be the same.":s&&e&&s.toLowerCase()===e.toLowerCase()?"Barcode 2 and Barcode 3 cannot be the same.":o&&(yield t.isBarcodeExists(o,i))?`Barcode '${o}' already exists. Please use a unique barcode.`:s&&(yield t.isBarcodeExists(s,i))?`Barcode '${s}' already exists. Please use a unique barcode.`:e&&(yield t.isBarcodeExists(e,i))?`Barcode '${e}' already exists. Please use a unique barcode.`:null})()}saveOfflineProductCreation(r){var n=this;return(0,l.A)(function*(){const d=r.barcode1?.trim()||null,i=r.barcode2?.trim()||null,t=r.barcode3?.trim()||null;if(d&&i&&d.toLowerCase()===i.toLowerCase())throw new Error("Barcode 1 and Barcode 2 cannot be the same.");if(d&&t&&d.toLowerCase()===t.toLowerCase())throw new Error("Barcode 1 and Barcode 3 cannot be the same.");if(i&&t&&i.toLowerCase()===t.toLowerCase())throw new Error("Barcode 2 and Barcode 3 cannot be the same.");const o=[d,i,t].filter(a=>a&&""!==a.trim());for(const a of o)if(a&&(yield n.isBarcodeExists(a)))throw new Error(`Barcode '${a}' already exists. Please use a unique barcode.`);const c=(yield n.getDB()).transaction(h,"readwrite").objectStore(h);return new Promise((a,u)=>{const b=c.put(r);b.onsuccess=()=>{console.log("Offline product creation saved:",r.offlineProductId),a()},b.onerror=()=>u(b.error)})})()}getPendingProductCreations(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(h,"readonly").objectStore(h);return new Promise((t,o)=>{const s=[],e=i.openCursor();e.onsuccess=c=>{const a=c.target.result;if(a){const u=a.value;!1===u.synced&&s.push(u),a.continue()}else t(s)},e.onerror=()=>o(e.error)})})()}getAllOfflineProductCreations(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(h,"readonly").objectStore(h);return new Promise((t,o)=>{const s=i.getAll();s.onsuccess=()=>t(s.result||[]),s.onerror=()=>o(s.error)})})()}markProductCreationSynced(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(h,"readwrite").objectStore(h);return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>{const a=c.result;if(a){a.synced=!0,a.syncedProductId=n;const u=o.put(a);u.onsuccess=()=>s(),u.onerror=()=>e(u.error)}else s()},c.onerror=()=>e(c.error)})})()}updateProductCreationError(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(h,"readwrite").objectStore(h);return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>{const a=c.result;if(a){a.syncError=n;const u=o.put(a);u.onsuccess=()=>s(),u.onerror=()=>e(u.error)}else s()},c.onerror=()=>e(c.error)})})()}removeOfflineProductCreation(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(h,"readwrite").objectStore(h);return new Promise((o,s)=>{const e=t.delete(r);e.onsuccess=()=>o(),e.onerror=()=>s(e.error)})})()}getPendingProductCreationsCount(){var r=this;return(0,l.A)(function*(){return(yield r.getPendingProductCreations()).length})()}applyEditToProductCreation(r,n){var d=this;return(0,l.A)(function*(){const t=(yield d.getPendingProductCreations()).find(c=>c.tempProductId===r);if(!t)return!1;void 0!==n.price&&(t.price=n.price),void 0!==n.originalPrice&&(t.originalPrice=n.originalPrice),void 0!==n.stockQuantity&&(t.stockQuantity=n.stockQuantity),void 0!==n.sku&&(t.sku=n.sku),void 0!==n.barcode1&&(t.barcode1=n.barcode1),void 0!==n.barcode2&&(t.barcode2=n.barcode2),void 0!==n.barcode3&&(t.barcode3=n.barcode3),void 0!==n.customName&&(t.customName=n.customName),void 0!==n.nameTamil&&(t.nameTamil=n.nameTamil);const e=(yield d.getDB()).transaction(h,"readwrite").objectStore(h);return new Promise((c,a)=>{const u=e.put(t);u.onsuccess=()=>{console.log("Applied edit changes to offline creation:",t.offlineProductId),c(!0)},u.onerror=()=>a(u.error)})})()}addOfflineProductToLocalCache(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(m,"readwrite").objectStore(m),s={id:n,shopId:r.shopId,name:r.customName||r.name,nameTamil:r.nameTamil,price:r.price,originalPrice:r.originalPrice||r.price,stock:r.stockQuantity,trackInventory:r.trackInventory,sku:"",barcode:r.barcode1,barcode1:r.barcode1,barcode2:r.barcode2,barcode3:r.barcode3,image:"",imageBase64:r.imageBase64,categoryId:void 0,categoryName:""};return new Promise((e,c)=>{const a=o.put(s);a.onsuccess=()=>{console.log("Offline product added to local cache:",n),e()},a.onerror=()=>c(a.error)})})()}updateLocalProductId(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(m,"readwrite").objectStore(m);return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>{const a=c.result;if(a){const u=o.delete(r);u.onsuccess=()=>{a.id=n;const b=o.put(a);b.onsuccess=()=>{console.log(`Updated product ID from ${r} to ${n}`),s()},b.onerror=()=>e(b.error)},u.onerror=()=>e(u.error)}else s()},c.onerror=()=>e(c.error)})})()}isBarcodeExistsLocally(r,n){var d=this;return(0,l.A)(function*(){if(!r||""===r.trim())return!1;const i=r.trim().toLowerCase();return(yield d.getProducts()).some(o=>Number(o.id)!==Number(n)&&(o.barcode&&o.barcode.toLowerCase()===i||o.barcode1&&o.barcode1.toLowerCase()===i||o.barcode2&&o.barcode2.toLowerCase()===i||o.barcode3&&o.barcode3.toLowerCase()===i))})()}saveOrdersCache(r,n){var d=this;return(0,l.A)(function*(){const t=(yield d.getDB()).transaction([B,g],"readwrite"),o=t.objectStore(B),s=t.objectStore(g),c=o.index("shopId").openCursor(IDBKeyRange.only(n));yield new Promise((a,u)=>{c.onsuccess=b=>{const f=b.target.result;f?(o.delete(f.primaryKey),f.continue()):a()},c.onerror=()=>u(c.error)});for(const a of r){const u={...a,shopId:n};o.put(u)}return s.put({key:`orders_cache_sync_${n}`,timestamp:(new Date).toISOString(),count:r.length}),new Promise((a,u)=>{t.oncomplete=()=>{console.log(`Cached ${r.length} orders for shop ${n}`),a()},t.onerror=()=>u(t.error)})})()}getOrdersCache(r){var n=this;return(0,l.A)(function*(){const o=(yield n.getDB()).transaction(B,"readonly").objectStore(B).index("shopId");return new Promise((s,e)=>{const c=o.getAll(IDBKeyRange.only(r));c.onsuccess=()=>{const a=(c.result||[]).sort((u,b)=>new Date(b.createdAt).getTime()-new Date(u.createdAt).getTime());s(a)},c.onerror=()=>e(c.error)})})()}getOrdersCacheSyncTime(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(g,"readonly").objectStore(g);return new Promise((o,s)=>{const e=t.get(`orders_cache_sync_${r}`);e.onsuccess=()=>{const c=e.result;o(c?new Date(c.timestamp):null)},e.onerror=()=>s(e.error)})})()}updateCachedOrderStatus(r,n){var d=this;return(0,l.A)(function*(){const o=(yield d.getDB()).transaction(B,"readwrite").objectStore(B);return new Promise((s,e)=>{const c=o.get(r);c.onsuccess=()=>{const a=c.result;if(a){a.status=n,a.updatedAt=(new Date).toISOString();const u=o.put(a);u.onsuccess=()=>{console.log("Cached order status updated:",r,n),s()},u.onerror=()=>e(u.error)}else s()},c.onerror=()=>e(c.error)})})()}saveDashboardCache(r){var n=this;return(0,l.A)(function*(){const i=(yield n.getDB()).transaction([C,g],"readwrite"),t=i.objectStore(C),o=i.objectStore(g),s={...r,key:`dashboard_stats_${r.shopId}`,cachedAt:(new Date).toISOString()};return t.put(s),o.put({key:`dashboard_cache_sync_${r.shopId}`,timestamp:(new Date).toISOString()}),new Promise((e,c)=>{i.oncomplete=()=>{console.log(`Cached dashboard stats for shop ${r.shopId}`),e()},i.onerror=()=>c(i.error)})})()}getDashboardCache(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(C,"readonly").objectStore(C);return new Promise((o,s)=>{const e=t.get(`dashboard_stats_${r}`);e.onsuccess=()=>o(e.result||null),e.onerror=()=>s(e.error)})})()}getDashboardCacheSyncTime(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(g,"readonly").objectStore(g);return new Promise((o,s)=>{const e=t.get(`dashboard_cache_sync_${r}`);e.onsuccess=()=>{const c=e.result;o(c?new Date(c.timestamp):null)},e.onerror=()=>s(e.error)})})()}saveCombosCache(r,n){var d=this;return(0,l.A)(function*(){const t=(yield d.getDB()).transaction([D,g],"readwrite"),o=t.objectStore(D),s=t.objectStore(g),c=o.index("shopId").openCursor(IDBKeyRange.only(n));yield new Promise((a,u)=>{c.onsuccess=b=>{const f=b.target.result;f?(o.delete(f.primaryKey),f.continue()):a()},c.onerror=()=>u(c.error)});for(const a of r){const u={...a,shopId:n};o.put(u)}return s.put({key:`combos_cache_sync_${n}`,timestamp:(new Date).toISOString(),count:r.length}),new Promise((a,u)=>{t.oncomplete=()=>{console.log(`Cached ${r.length} combos for shop ${n}`),a()},t.onerror=()=>u(t.error)})})()}getCombosCache(r){var n=this;return(0,l.A)(function*(){const o=(yield n.getDB()).transaction(D,"readonly").objectStore(D).index("shopId");return new Promise((s,e)=>{const c=o.getAll(IDBKeyRange.only(r));c.onsuccess=()=>s(c.result||[]),c.onerror=()=>e(c.error)})})()}getCombosCacheSyncTime(r){var n=this;return(0,l.A)(function*(){const t=(yield n.getDB()).transaction(g,"readonly").objectStore(g);return new Promise((o,s)=>{const e=t.get(`combos_cache_sync_${r}`);e.onsuccess=()=>{const c=e.result;o(c?new Date(c.timestamp):null)},e.onerror=()=>s(e.error)})})()}cacheImage(r,n){var d=this;return(0,l.A)(function*(){if(!r||!n)return;const o=(yield d.getDB()).transaction(_,"readwrite").objectStore(_),s={url:r,blob:n,mimeType:n.type,size:n.size,cachedAt:(new Date).toISOString()};return new Promise((e,c)=>{const a=o.put(s);a.onsuccess=()=>e(),a.onerror=()=>c(a.error)})})()}getCachedImage(r){var n=this;return(0,l.A)(function*(){if(!r)return null;const t=(yield n.getDB()).transaction(_,"readonly").objectStore(_);return new Promise((o,s)=>{const e=t.get(r);e.onsuccess=()=>{const c=e.result;o(c?c.blob:null)},e.onerror=()=>s(e.error)})})()}isImageCached(r){var n=this;return(0,l.A)(function*(){if(!r)return!1;const t=(yield n.getDB()).transaction(_,"readonly").objectStore(_);return new Promise((o,s)=>{const e=t.count(IDBKeyRange.only(r));e.onsuccess=()=>o(e.result>0),e.onerror=()=>s(e.error)})})()}cacheImages(r,n){var d=this;return(0,l.A)(function*(){const i=r.filter(s=>s&&""!==s.trim());if(0===i.length)return 0;let t=0,o=0;for(const s of i){try{if(yield d.isImageCached(s)){t++,n&&n(t,i.length);continue}const c=yield fetch(s,{mode:"cors",credentials:"omit"});if(c.ok){const a=yield c.blob();yield d.cacheImage(s,a),t++}else o++}catch(e){console.warn(`Failed to cache image: ${s}`,e),o++}n&&n(t,i.length)}return console.log(`Image caching complete: ${t} cached, ${o} failed out of ${i.length}`),t})()}getImageCacheStats(){var r=this;return(0,l.A)(function*(){const i=(yield r.getDB()).transaction(_,"readonly").objectStore(_);return new Promise((t,o)=>{let s=0,e=0;const c=i.openCursor();c.onsuccess=a=>{const u=a.target.result;u?(s++,e+=u.value.size||0,u.continue()):t({count:s,totalSize:e})},c.onerror=()=>o(c.error)})})()}clearOldCachedImages(){var r=this;return(0,l.A)(function*(n=30){const t=(yield r.getDB()).transaction(_,"readwrite").objectStore(_),o=new Date;return o.setDate(o.getDate()-n),new Promise((s,e)=>{let c=0;const a=t.openCursor();a.onsuccess=u=>{const b=u.target.result;b?(new Date(b.value.cachedAt)<o&&(t.delete(b.primaryKey),c++),b.continue()):(console.log(`Cleared ${c} old cached images`),s(c))},a.onerror=()=>e(a.error)})}).apply(this,arguments)}static{this.\u0275fac=function(n){return new(n||A)}}static{this.\u0275prov=x.jDH({token:A,factory:A.\u0275fac,providedIn:"root"})}}return A})()}}]);