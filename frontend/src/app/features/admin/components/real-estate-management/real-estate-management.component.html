<div class="real-estate-management">
  <div class="header">
    <h2>Real Estate Management</h2>
    <p class="subtitle">Review and manage property listing posts</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button mat-flat-button
            [color]="activeTab === 'pending' ? 'primary' : undefined"
            (click)="switchTab('pending')">
      Pending Approval
    </button>
    <button mat-flat-button
            [color]="activeTab === 'all' ? 'primary' : undefined"
            (click)="switchTab('all')">
      All Posts
    </button>
  </div>

  <!-- Search Filter -->
  <div class="search-filter" *ngIf="activeTab === 'all'">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search by location</mat-label>
      <input matInput [(ngModel)]="searchText" (keyup.enter)="onSearchChange()" placeholder="Type location and press Enter...">
      <button mat-icon-button matSuffix *ngIf="searchText" (click)="searchText = ''; onSearchChange()">
        <mat-icon>clear</mat-icon>
      </button>
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading posts...</p>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && posts.length === 0" class="empty-state">
    <mat-icon class="empty-icon">home_work</mat-icon>
    <h3>No posts found</h3>
    <p *ngIf="activeTab === 'pending'">No property listings are waiting for approval.</p>
    <p *ngIf="activeTab === 'all'">No real estate posts yet.</p>
  </div>

  <!-- Posts table -->
  <div *ngIf="!loading && posts.length > 0" class="posts-container">
    <table mat-table [dataSource]="posts" class="posts-table">

      <!-- Image Column -->
      <ng-container matColumnDef="image">
        <th mat-header-cell *matHeaderCellDef>Image</th>
        <td mat-cell *matCellDef="let post">
          <div class="post-image" [class.clickable]="post.imageUrls" (click)="post.imageUrls && openGallery(post)">
            <img *ngIf="post.imageUrls"
                 [src]="getFirstImageUrl(post.imageUrls)"
                 alt="Property"
                 loading="lazy">
            <mat-icon *ngIf="!post.imageUrls" class="no-image">home</mat-icon>
            <span class="image-count" *ngIf="getImageCount(post.imageUrls) > 1">
              {{ getImageCount(post.imageUrls) }}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Title Column -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Title</th>
        <td mat-cell *matCellDef="let post">
          <div class="post-title">{{ post.title }}</div>
          <div class="post-description" *ngIf="post.description">{{ post.description }}</div>
        </td>
      </ng-container>

      <!-- Property Type Column -->
      <ng-container matColumnDef="propertyType">
        <th mat-header-cell *matHeaderCellDef>Type</th>
        <td mat-cell *matCellDef="let post">
          <span class="type-chip property-type">{{ getPropertyTypeLabel(post.propertyType) }}</span>
          <span class="type-chip listing-type" [ngClass]="post.listingType === 'FOR_RENT' ? 'rent' : 'sale'">
            {{ getListingTypeLabel(post.listingType) }}
          </span>
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Price</th>
        <td mat-cell *matCellDef="let post">
          <span class="price">{{ formatPrice(post.price) }}</span>
          <span class="area" *ngIf="post.areaSqft">{{ post.areaSqft }} sq.ft</span>
        </td>
      </ng-container>

      <!-- Owner Column -->
      <ng-container matColumnDef="owner">
        <th mat-header-cell *matHeaderCellDef>Owner</th>
        <td mat-cell *matCellDef="let post">
          <div class="owner-info">
            <span class="owner-name">{{ post.ownerName }}</span>
            <span class="owner-phone">{{ post.ownerPhone }}</span>
            <span class="owner-location" *ngIf="post.location">{{ post.location }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let post">
          <span class="status-badge" [ngClass]="'status-' + post.status?.toLowerCase()">
            {{ getStatusLabel(post.status) }}
          </span>
        </td>
      </ng-container>

      <!-- Type Column (Paid/Free) -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef>Type</th>
        <td mat-cell *matCellDef="let post">
          <span *ngIf="post.isPaid" class="type-badge type-paid">
            <mat-icon class="badge-icon">payments</mat-icon> PAID
          </span>
          <span *ngIf="!post.isPaid" class="type-badge type-free">FREE</span>
        </td>
      </ng-container>

      <!-- Featured Column -->
      <ng-container matColumnDef="featured">
        <th mat-header-cell *matHeaderCellDef>Featured</th>
        <td mat-cell *matCellDef="let post">
          <button mat-icon-button
                  class="featured-toggle"
                  [class.is-featured]="post.isFeatured"
                  (click)="toggleFeatured(post)"
                  [matTooltip]="post.isFeatured ? 'Remove from featured' : 'Mark as featured'">
            <mat-icon>{{ post.isFeatured ? 'star' : 'star_border' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Date Column -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let post">
          <span class="date">{{ formatDate(post.createdAt) }}</span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let post">
          <div class="action-buttons">
            <button mat-icon-button color="primary"
                    (click)="editPost(post)"
                    matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="primary"
                    *ngIf="post.status === 'PENDING_APPROVAL'"
                    (click)="approvePost(post)"
                    matTooltip="Approve">
              <mat-icon>check_circle</mat-icon>
            </button>
            <button mat-icon-button color="warn"
                    *ngIf="post.status === 'PENDING_APPROVAL'"
                    (click)="rejectPost(post)"
                    matTooltip="Reject">
              <mat-icon>cancel</mat-icon>
            </button>
            <button mat-icon-button color="warn"
                    (click)="deletePost(post)"
                    matTooltip="Delete">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['image', 'title', 'propertyType', 'price', 'owner', 'status', 'type', 'featured', 'date', 'actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['image', 'title', 'propertyType', 'price', 'owner', 'status', 'type', 'featured', 'date', 'actions']"></tr>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button mat-button [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)">
        <mat-icon>chevron_left</mat-icon> Previous
      </button>
      <span class="page-info">Page {{ currentPage + 1 }} of {{ totalPages }} ({{ totalItems }} posts)</span>
      <button mat-button [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)">
        Next <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
  </div>

  <!-- Image Gallery Lightbox -->
  <div class="gallery-overlay" *ngIf="galleryOpen" (click)="closeGallery()">
    <div class="gallery-content" (click)="$event.stopPropagation()">
      <button class="gallery-close" (click)="closeGallery()">
        <mat-icon>close</mat-icon>
      </button>
      <div class="gallery-title">{{ galleryTitle }}</div>
      <div class="gallery-image-container">
        <button class="gallery-nav prev" *ngIf="galleryImages.length > 1" (click)="prevImage()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <img [src]="galleryImages[galleryIndex]" alt="Property photo" class="gallery-image">
        <button class="gallery-nav next" *ngIf="galleryImages.length > 1" (click)="nextImage()">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
      <div class="gallery-counter">{{ galleryIndex + 1 }} / {{ galleryImages.length }}</div>
      <div class="gallery-thumbnails" *ngIf="galleryImages.length > 1">
        <img *ngFor="let img of galleryImages; let i = index"
             [src]="img"
             [class.active]="i === galleryIndex"
             (click)="galleryIndex = i"
             alt="Thumbnail">
      </div>
    </div>
  </div>
</div>
