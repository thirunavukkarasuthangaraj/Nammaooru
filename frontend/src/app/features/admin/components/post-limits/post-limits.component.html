<div class="post-limits-management">
  <div class="page-header">
    <h2>Post Limits</h2>
    <p class="subtitle">Manage global post limits for all users and set user-specific overrides.</p>
    <div class="header-actions">
      <button mat-icon-button (click)="loadGlobalLimits(); loadLimits()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- ===== SECTION 1: Global Limits ===== -->
  <div class="section-header">
    <h3><mat-icon>public</mat-icon> Global Limits</h3>
    <p class="section-subtitle">Default post limits applied to all users. Set 0 for unlimited.</p>
  </div>

  <div *ngIf="globalLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading global limits...</p>
  </div>

  <div *ngIf="!globalLoading" class="table-container global-table">
    <table mat-table [dataSource]="globalLimits" class="limits-table">
      <ng-container matColumnDef="featureName">
        <th mat-header-cell *matHeaderCellDef>Feature</th>
        <td mat-cell *matCellDef="let g">
          <strong>{{ getGlobalFeatureLabel(g.featureName) }}</strong>
        </td>
      </ng-container>

      <ng-container matColumnDef="maxPosts">
        <th mat-header-cell *matHeaderCellDef>Max Posts Per User</th>
        <td mat-cell *matCellDef="let g">
          <ng-container *ngIf="editingGlobalId !== g.id">
            <span *ngIf="!g.maxPostsPerUser || g.maxPostsPerUser === 0" class="text-muted">Unlimited</span>
            <span *ngIf="g.maxPostsPerUser > 0" class="limit-badge">{{ g.maxPostsPerUser }}</span>
          </ng-container>
          <mat-form-field *ngIf="editingGlobalId === g.id" class="inline-edit">
            <input matInput type="number" [(ngModel)]="editGlobalValue" min="0" placeholder="0 = unlimited">
          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let g">
          <ng-container *ngIf="editingGlobalId !== g.id">
            <button mat-icon-button matTooltip="Edit limit" color="primary" (click)="startEditGlobal(g)">
              <mat-icon>edit</mat-icon>
            </button>
          </ng-container>
          <ng-container *ngIf="editingGlobalId === g.id">
            <button mat-icon-button matTooltip="Save" color="primary" (click)="saveGlobalLimit(g)">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Cancel" (click)="cancelEditGlobal()">
              <mat-icon>close</mat-icon>
            </button>
          </ng-container>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="globalDisplayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: globalDisplayedColumns;"></tr>
    </table>

    <div *ngIf="globalLimits.length === 0" class="empty-state">
      <mat-icon>settings</mat-icon>
      <p>No post features configured.</p>
    </div>
  </div>

  <!-- ===== SECTION 2: User-Specific Overrides ===== -->
  <div class="section-header user-section">
    <h3><mat-icon>person</mat-icon> User-Specific Overrides</h3>
    <p class="section-subtitle">Override the global limit for specific users. These take priority over global limits.</p>
    <div class="section-actions">
      <button mat-raised-button color="primary" (click)="openAddForm()" *ngIf="!showForm">
        <mat-icon>add</mat-icon> Add Override
      </button>
    </div>
  </div>

  <!-- Add Form -->
  <mat-card *ngIf="showForm" class="form-card">
    <mat-card-content>
      <h4>Add / Update User Override</h4>
      <form [formGroup]="limitForm" (ngSubmit)="saveLimit()" class="limit-form">
        <div class="form-row">
          <mat-form-field class="user-lookup-field">
            <mat-label>Mobile Number or Email</mat-label>
            <input matInput formControlName="userIdentifier" placeholder="Enter mobile number or email">
            <button mat-icon-button matSuffix type="button" (click)="lookupUser()" matTooltip="Verify user">
              <mat-icon>search</mat-icon>
            </button>
            <mat-hint>Enter the user's mobile number or email address</mat-hint>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Feature</mat-label>
            <mat-select formControlName="featureName">
              <mat-option *ngFor="let f of featureNames" [value]="f.value">
                {{ f.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Max Posts</mat-label>
            <input matInput type="number" formControlName="maxPosts" placeholder="0 = unlimited">
            <mat-hint>0 = unlimited, overrides the global limit</mat-hint>
          </mat-form-field>
        </div>

        <!-- User lookup result -->
        <div *ngIf="lookupLoading" class="lookup-status">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Looking up user...</span>
        </div>
        <div *ngIf="lookupResult" class="lookup-result success">
          <mat-icon>check_circle</mat-icon>
          <span>
            <strong>{{ lookupResult.firstName }} {{ lookupResult.lastName }}</strong>
            &nbsp;|&nbsp; {{ lookupResult.mobileNumber }}
            &nbsp;|&nbsp; {{ lookupResult.email }}
          </span>
        </div>
        <div *ngIf="lookupError" class="lookup-result error">
          <mat-icon>error</mat-icon>
          <span>{{ lookupError }}</span>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="limitForm.invalid">
            Save
          </button>
          <button mat-button type="button" (click)="cancelForm()">Cancel</button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading user overrides...</p>
  </div>

  <!-- User Overrides Table -->
  <div *ngIf="!isLoading" class="table-container">
    <table mat-table [dataSource]="limits" class="limits-table">
      <ng-container matColumnDef="userInfo">
        <th mat-header-cell *matHeaderCellDef>User</th>
        <td mat-cell *matCellDef="let l">
          <div class="user-cell">
            <strong>{{ l.userName || 'User #' + l.userId }}</strong>
            <small *ngIf="l.mobileNumber">{{ l.mobileNumber }}</small>
            <small *ngIf="l.email" class="text-muted">{{ l.email }}</small>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="featureName">
        <th mat-header-cell *matHeaderCellDef>Feature</th>
        <td mat-cell *matCellDef="let l">{{ getFeatureLabel(l.featureName) }}</td>
      </ng-container>

      <ng-container matColumnDef="maxPosts">
        <th mat-header-cell *matHeaderCellDef>Max Posts</th>
        <td mat-cell *matCellDef="let l">
          <span *ngIf="l.maxPosts === 0" class="text-muted">Unlimited</span>
          <span *ngIf="l.maxPosts > 0"><strong>{{ l.maxPosts }}</strong></span>
        </td>
      </ng-container>

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef>Created</th>
        <td mat-cell *matCellDef="let l">{{ l.createdAt | date:'short' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let l">
          <button mat-icon-button matTooltip="Delete" color="warn" (click)="deleteLimit(l)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <div *ngIf="limits.length === 0" class="empty-state">
      <mat-icon>rule</mat-icon>
      <p>No user-specific overrides found.</p>
      <p class="hint">All users are using the global limits.</p>
    </div>
  </div>
</div>
