<div class="post-limits-management">
  <div class="page-header">
    <h2>Post Configuration</h2>
    <p class="subtitle">Configure limits, pricing, settings and user overrides for all post types.</p>
    <div class="header-actions">
      <button mat-icon-button (click)="loadGlobalLimits(); loadLimits()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- ===== SERVICE AREA RESTRICTION ===== -->
  <div class="section-header">
    <h3><mat-icon>location_on</mat-icon> Service Area Restriction</h3>
    <p class="section-subtitle">Restrict the app to a geographic area. Users outside the radius will see "Service Not Available".</p>
  </div>

  <div *ngIf="serviceAreaLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading...</p>
  </div>

  <mat-card *ngIf="!serviceAreaLoading" class="paid-post-card">
    <mat-card-content>
      <div class="paid-post-form">
        <div class="paid-post-toggle">
          <mat-slide-toggle [(ngModel)]="serviceAreaEnabled" color="primary">
            Enable Service Area Restriction
          </mat-slide-toggle>
          <span class="toggle-hint" *ngIf="serviceAreaEnabled">Users outside the radius will be blocked</span>
          <span class="toggle-hint" *ngIf="!serviceAreaEnabled">App is available everywhere (no geo restriction)</span>
        </div>

        <div class="paid-post-fields" *ngIf="serviceAreaEnabled">
          <mat-form-field>
            <mat-label>Center Latitude</mat-label>
            <input matInput type="number" [(ngModel)]="serviceAreaLat" step="0.0001" placeholder="12.4955">
            <mat-hint>Latitude of service area center</mat-hint>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Center Longitude</mat-label>
            <input matInput type="number" [(ngModel)]="serviceAreaLng" step="0.0001" placeholder="78.5514">
            <mat-hint>Longitude of service area center</mat-hint>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Radius (km)</mat-label>
            <input matInput type="number" [(ngModel)]="serviceAreaRadius" min="1" max="500" placeholder="50">
            <mat-hint>Service area radius in kilometers</mat-hint>
          </mat-form-field>
        </div>

        <div class="paid-post-actions">
          <button mat-raised-button color="primary" (click)="saveServiceAreaConfig()" [disabled]="serviceAreaSaving">
            <mat-icon>save</mat-icon>
            {{ serviceAreaSaving ? 'Saving...' : 'Save' }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ===== SECTION 0: Global Free Post Limit ===== -->
  <div class="section-header">
    <h3><mat-icon>lock_open</mat-icon> Global Free Post Limit</h3>
    <p class="section-subtitle">Number of free posts allowed across all modules before payment is required.</p>
  </div>

  <div *ngIf="globalFreePostLimitLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading...</p>
  </div>

  <mat-card *ngIf="!globalFreePostLimitLoading" class="paid-post-card">
    <mat-card-content>
      <div class="paid-post-form">
        <div class="paid-post-fields">
          <mat-form-field>
            <mat-label>Free Posts Before Payment</mat-label>
            <input matInput type="number" [(ngModel)]="globalFreePostLimit" min="-1" placeholder="1">
            <mat-hint>0 = all posts require payment, 1 = first post free then pay, 2 = two free posts, -1 = unlimited (all free)</mat-hint>
          </mat-form-field>
        </div>
        <div class="paid-post-actions">
          <button mat-raised-button color="primary" (click)="saveGlobalFreePostLimit()" [disabled]="globalFreePostLimitSaving">
            <mat-icon>save</mat-icon>
            {{ globalFreePostLimitSaving ? 'Saving...' : 'Save' }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ===== SECTION 1: Global Limits ===== -->
  <div class="section-header">
    <h3><mat-icon>public</mat-icon> Per-Module Limits</h3>
    <p class="section-subtitle">Default post limits per module applied to all users. Set 0 for unlimited.</p>
  </div>

  <div *ngIf="globalLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading global limits...</p>
  </div>

  <div *ngIf="!globalLoading" class="table-container global-table">
    <table mat-table [dataSource]="globalLimits" class="limits-table">
      <ng-container matColumnDef="featureName">
        <th mat-header-cell *matHeaderCellDef>Feature</th>
        <td mat-cell *matCellDef="let g">
          <strong>{{ getGlobalFeatureLabel(g.featureName) }}</strong>
        </td>
      </ng-container>

      <ng-container matColumnDef="maxPosts">
        <th mat-header-cell *matHeaderCellDef>Max Posts Per User</th>
        <td mat-cell *matCellDef="let g">
          <ng-container *ngIf="editingGlobalId !== g.id">
            <span *ngIf="!g.maxPostsPerUser || g.maxPostsPerUser === 0" class="text-muted">Unlimited</span>
            <span *ngIf="g.maxPostsPerUser > 0" class="limit-badge">{{ g.maxPostsPerUser }}</span>
          </ng-container>
          <mat-form-field *ngIf="editingGlobalId === g.id" class="inline-edit">
            <input matInput type="number" [(ngModel)]="editGlobalValue" min="0" placeholder="0 = unlimited">
          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let g">
          <ng-container *ngIf="editingGlobalId !== g.id">
            <button mat-icon-button matTooltip="Edit limit" color="primary" (click)="startEditGlobal(g)">
              <mat-icon>edit</mat-icon>
            </button>
          </ng-container>
          <ng-container *ngIf="editingGlobalId === g.id">
            <button mat-icon-button matTooltip="Save" color="primary" (click)="saveGlobalLimit(g)">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Cancel" (click)="cancelEditGlobal()">
              <mat-icon>close</mat-icon>
            </button>
          </ng-container>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="globalDisplayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: globalDisplayedColumns;"></tr>
    </table>

    <div *ngIf="globalLimits.length === 0" class="empty-state">
      <mat-icon>settings</mat-icon>
      <p>No post features configured.</p>
    </div>
  </div>

  <!-- ===== SECTION 2: Paid Posts Config ===== -->
  <div class="section-header paid-section">
    <h3><mat-icon>payment</mat-icon> Paid Posts Config</h3>
    <p class="section-subtitle">When users exceed their free post limit, they can pay to create additional posts.</p>
  </div>

  <div *ngIf="paidPostLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading paid post config...</p>
  </div>

  <mat-card *ngIf="!paidPostLoading" class="paid-post-card">
    <mat-card-content>
      <div class="paid-post-form">
        <div class="paid-post-toggle">
          <mat-slide-toggle [(ngModel)]="paidPostEnabled" color="primary">
            Enable Paid Posts
          </mat-slide-toggle>
          <span class="toggle-hint" *ngIf="paidPostEnabled">Users can pay to post beyond their free limit</span>
          <span class="toggle-hint" *ngIf="!paidPostEnabled">Users will be blocked when they reach their free limit</span>
        </div>

        <div class="paid-post-fields" *ngIf="paidPostEnabled">
          <mat-form-field>
            <mat-label>Currency</mat-label>
            <mat-select [(ngModel)]="paidPostCurrency">
              <mat-option value="INR">INR (Indian Rupee)</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="paid-post-actions">
          <button mat-raised-button color="primary" (click)="savePaidPostConfig()" [disabled]="paidPostSaving">
            <mat-icon>save</mat-icon>
            {{ paidPostSaving ? 'Saving...' : 'Save Config' }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Per-Type Pricing Section -->
  <div class="config-section" *ngIf="paidPostEnabled">
    <h3>Paid Post Pricing</h3>
    <p class="section-subtitle">Set different prices for each post type</p>

    <div class="pricing-grid">
      <div class="pricing-row pricing-header">
        <span class="pricing-label">Post Type</span>
        <span class="pricing-value">Price (&#8377;)</span>
      </div>
      <div class="pricing-row" *ngFor="let type of postTypes">
        <span class="pricing-label">{{ type.label }}</span>
        <div class="pricing-input">
          <span class="currency-prefix">&#8377;</span>
          <input type="number"
                 [(ngModel)]="postTypePrices[type.key]"
                 min="1" max="1000"
                 class="price-input">
        </div>
      </div>
    </div>

    <div class="config-actions">
      <button mat-raised-button color="primary" (click)="savePostTypePrices()" [disabled]="savingPrices">
        {{ savingPrices ? 'Saving...' : 'Save Prices' }}
      </button>
    </div>
  </div>

  <!-- ===== SECTION 3: Post Type Settings ===== -->
  <div class="section-header">
    <h3><mat-icon>tune</mat-icon> Post Type Settings</h3>
    <p class="section-subtitle">Configure duration, auto-approve, report threshold and visible statuses per post type.</p>
  </div>

  <div *ngIf="typeSettingsLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading post type settings...</p>
  </div>

  <div *ngIf="!typeSettingsLoading">
    <div class="type-tabs">
      <button *ngFor="let pt of postTypeConfigs; let i = index"
              class="type-tab"
              [class.active]="selectedTabIndex === i"
              [style.--tab-color]="pt.color"
              (click)="selectedTabIndex = i">
        <mat-icon>{{ pt.icon }}</mat-icon>
        <span class="tab-label">{{ pt.label }}</span>
      </button>
    </div>

    <ng-container *ngFor="let pt of postTypeConfigs; let i = index">
      <mat-card *ngIf="selectedTabIndex === i" class="paid-post-card" [style.border-top]="'3px solid ' + pt.color">
        <mat-card-content>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Post Visibility Duration</div>
              <div class="setting-desc">How long posts remain visible to users</div>
            </div>
            <mat-form-field appearance="outline" class="setting-control">
              <mat-select [(value)]="pt.durationDays">
                <mat-option *ngFor="let opt of durationOptions" [value]="opt.value">
                  {{ opt.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Auto Approve Posts</div>
              <div class="setting-desc">New posts approved automatically without admin review</div>
            </div>
            <mat-slide-toggle [(ngModel)]="pt.autoApprove" color="primary"></mat-slide-toggle>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Report Threshold</div>
              <div class="setting-desc">Reports needed to auto-flag a post</div>
            </div>
            <mat-form-field appearance="outline" class="setting-control small">
              <input matInput type="number" [(ngModel)]="pt.reportThreshold" min="1" max="50">
            </mat-form-field>
          </div>

          <div class="setting-block">
            <div class="setting-label">Visible Statuses</div>
            <div class="setting-desc">Which post statuses are visible to the public</div>
            <div class="status-chips">
              <mat-checkbox *ngFor="let status of allStatuses"
                [checked]="isStatusChecked(pt, status)"
                (change)="toggleStatus(pt, status)"
                color="primary">
                {{ statusLabels[status] }}
              </mat-checkbox>
            </div>
          </div>

          <div class="paid-post-actions">
            <button mat-raised-button color="primary" (click)="savePostTypeSettings(pt)" [disabled]="savingType === pt.key">
              <mat-icon>save</mat-icon>
              {{ savingType === pt.key ? 'Saving...' : 'Save ' + pt.label + ' Settings' }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </div>

  <!-- ===== SECTION 4: User-Specific Overrides ===== -->
  <div class="section-header user-section">
    <h3><mat-icon>person</mat-icon> User-Specific Overrides</h3>
    <p class="section-subtitle">Override the global limit for specific users. These take priority over global limits.</p>
    <div class="section-actions">
      <button mat-raised-button color="primary" (click)="openAddForm()" *ngIf="!showForm">
        <mat-icon>add</mat-icon> Add Override
      </button>
    </div>
  </div>

  <!-- Add Form -->
  <mat-card *ngIf="showForm" class="form-card">
    <mat-card-content>
      <h4>Add / Update User Override</h4>
      <form [formGroup]="limitForm" (ngSubmit)="saveLimit()" class="limit-form">
        <div class="form-row">
          <mat-form-field class="user-lookup-field">
            <mat-label>Mobile Number or Email</mat-label>
            <input matInput formControlName="userIdentifier" placeholder="Enter mobile number or email">
            <button mat-icon-button matSuffix type="button" (click)="lookupUser()" matTooltip="Verify user">
              <mat-icon>search</mat-icon>
            </button>
            <mat-hint>Enter the user's mobile number or email address</mat-hint>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Feature</mat-label>
            <mat-select formControlName="featureName">
              <mat-option *ngFor="let f of featureNames" [value]="f.value">
                {{ f.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Max Posts</mat-label>
            <input matInput type="number" formControlName="maxPosts" placeholder="0 = unlimited">
            <mat-hint>0 = unlimited, overrides the global limit</mat-hint>
          </mat-form-field>
        </div>

        <!-- User lookup result -->
        <div *ngIf="lookupLoading" class="lookup-status">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Looking up user...</span>
        </div>
        <div *ngIf="lookupResult" class="lookup-result success">
          <mat-icon>check_circle</mat-icon>
          <span>
            <strong>{{ lookupResult.firstName }} {{ lookupResult.lastName }}</strong>
            &nbsp;|&nbsp; {{ lookupResult.mobileNumber }}
            &nbsp;|&nbsp; {{ lookupResult.email }}
          </span>
        </div>
        <div *ngIf="lookupError" class="lookup-result error">
          <mat-icon>error</mat-icon>
          <span>{{ lookupError }}</span>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="limitForm.invalid">
            Save
          </button>
          <button mat-button type="button" (click)="cancelForm()">Cancel</button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading user overrides...</p>
  </div>

  <!-- User Overrides Table -->
  <div *ngIf="!isLoading" class="table-container">
    <table mat-table [dataSource]="limits" class="limits-table">
      <ng-container matColumnDef="userInfo">
        <th mat-header-cell *matHeaderCellDef>User</th>
        <td mat-cell *matCellDef="let l">
          <div class="user-cell">
            <strong>{{ l.userName || 'User #' + l.userId }}</strong>
            <small *ngIf="l.mobileNumber">{{ l.mobileNumber }}</small>
            <small *ngIf="l.email" class="text-muted">{{ l.email }}</small>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="featureName">
        <th mat-header-cell *matHeaderCellDef>Feature</th>
        <td mat-cell *matCellDef="let l">{{ getFeatureLabel(l.featureName) }}</td>
      </ng-container>

      <ng-container matColumnDef="maxPosts">
        <th mat-header-cell *matHeaderCellDef>Max Posts</th>
        <td mat-cell *matCellDef="let l">
          <span *ngIf="l.maxPosts === 0" class="text-muted">Unlimited</span>
          <span *ngIf="l.maxPosts > 0"><strong>{{ l.maxPosts }}</strong></span>
        </td>
      </ng-container>

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef>Created</th>
        <td mat-cell *matCellDef="let l">{{ l.createdAt | date:'short' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let l">
          <button mat-icon-button matTooltip="Delete" color="warn" (click)="deleteLimit(l)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <div *ngIf="limits.length === 0" class="empty-state">
      <mat-icon>rule</mat-icon>
      <p>No user-specific overrides found.</p>
      <p class="hint">All users are using the global limits.</p>
    </div>
  </div>
</div>
