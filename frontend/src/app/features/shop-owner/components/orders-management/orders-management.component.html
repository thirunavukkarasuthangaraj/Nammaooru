<div class="orders-page">
  <!-- Stats Cards Row -->
  <div class="stats-cards-row">
    <div class="stat-card stat-total">
      <div class="stat-icon">
        <mat-icon>shopping_cart</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orders.length | number }}</div>
        <div class="stat-label">Total Orders</div>
      </div>
    </div>
    <div class="stat-card stat-revenue">
      <div class="stat-icon">
        <mat-icon>account_balance_wallet</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ todayRevenue | currency:'INR':'symbol':'1.0-0' }}</div>
        <div class="stat-label">Revenue</div>
      </div>
    </div>
    <div class="stat-card stat-active">
      <div class="stat-icon">
        <mat-icon>local_shipping</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getActiveDeliveriesCount() }}</div>
        <div class="stat-label">Active Deliveries</div>
      </div>
    </div>
    <div class="stat-card stat-delivered">
      <div class="stat-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ completedOrders.length }}</div>
        <div class="stat-label">Delivered</div>
      </div>
    </div>
  </div>

  <!-- Table Header -->
  <div class="table-header">
    <div class="table-title">
      <h2>Order Management</h2>
      <p>Manage and track all store transactions</p>
    </div>
    <div class="table-actions">
      <div class="filter-dropdown">
        <select [(ngModel)]="statusFilter" (change)="onFilterChange()" class="filter-select">
          <option value="ALL">All Orders</option>
          <option value="PENDING">Pending</option>
          <option value="CONFIRMED">Confirmed</option>
          <option value="PREPARING">Preparing</option>
          <option value="READY_FOR_PICKUP">Ready for Pickup</option>
          <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
          <option value="DELIVERED">Delivered</option>
          <option value="CANCELLED">Cancelled</option>
          <option value="WALK_IN">Walk-in Only</option>
          <option value="ONLINE">Online Only</option>
        </select>
        <mat-icon class="filter-icon">filter_list</mat-icon>
      </div>
      <div class="date-filters">
        <input type="date"
               [(ngModel)]="fromDate"
               (change)="onDateFilterChange()"
               class="date-input"
               title="From Date">
        <span class="date-separator">to</span>
        <input type="date"
               [(ngModel)]="toDate"
               (change)="onDateFilterChange()"
               class="date-input"
               title="To Date">
        <button class="clear-date-btn" (click)="clearDateFilter()" *ngIf="fromDate || toDate" title="Clear dates">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <input
        type="text"
        placeholder="Search orders..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
        class="search-input">
      <button class="export-btn" (click)="exportOrders()">
        <mat-icon>file_download</mat-icon>
        Export
      </button>
      <button class="refresh-btn" (click)="loadDashboardData()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="orders-table-container" (scroll)="onTableScroll($event)" #tableContainer>
    <table class="orders-table">
      <thead>
        <tr>
          <th class="col-order-id">ORDER ID</th>
          <th class="col-customer">CUSTOMER</th>
          <th class="col-type">TYPE</th>
          <th class="col-status">STATUS</th>
          <th class="col-total">TOTAL</th>
          <th class="col-action">ACTION</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of getPagedOrders()"
            class="order-row"
            [class.pending-row]="order.status === 'PENDING'">
          <!-- Loading Overlay -->
          <td colspan="6" *ngIf="isProcessingOrder(order.id)" class="processing-cell">
            <div class="processing-indicator">
              <mat-icon class="spin">sync</mat-icon>
              <span>Processing...</span>
            </div>
          </td>

          <ng-container *ngIf="!isProcessingOrder(order.id)">
            <!-- Order ID -->
            <td class="col-order-id">
              <span class="order-number" (click)="showOrderDetailsModal(order)">#{{ order.orderNumber }}</span>
              <div class="order-time">{{ formatOrderTime(order.createdAt) }}</div>
            </td>

            <!-- Customer -->
            <td class="col-customer">
              <div class="customer-info">
                <div class="customer-avatar">{{ getCustomerInitials(order.customerName) }}</div>
                <div class="customer-details">
                  <div class="customer-name">{{ order.customerName }}</div>
                  <div class="customer-phone" *ngIf="order.customerPhone">{{ order.customerPhone }}</div>
                </div>
              </div>
            </td>

            <!-- Type -->
            <td class="col-type">
              <div class="delivery-type" [ngClass]="getDeliveryTypeClass(order)">
                <mat-icon>{{ getDeliveryTypeIcon(order) }}</mat-icon>
                <span>{{ getDeliveryTypeLabel(order) }}</span>
              </div>
            </td>

            <!-- Status -->
            <td class="col-status">
              <span class="status-badge" [ngClass]="getStatusBadgeClass(order.status)">
                {{ getStatusLabel(order.status) }}
              </span>
            </td>

            <!-- Total -->
            <td class="col-total">
              <span class="total-amount">{{ order.totalAmount | currency:'INR':'symbol':'1.0-0' }}</span>
            </td>

            <!-- Actions -->
            <td class="col-action">
              <div class="action-buttons">
                <!-- Pending Actions -->
                <ng-container *ngIf="order.status === 'PENDING'">
                  <button class="btn-accept" (click)="acceptOrder(order)" title="Accept Order">
                    <mat-icon>check</mat-icon>
                  </button>
                  <button class="btn-reject" (click)="rejectOrder(order)" title="Reject Order">
                    <mat-icon>close</mat-icon>
                  </button>
                </ng-container>

                <!-- Confirmed Actions -->
                <button *ngIf="order.status === 'CONFIRMED'"
                        class="btn-action btn-prepare"
                        (click)="startPreparing(order.id)"
                        title="Start Preparing">
                  <mat-icon>restaurant</mat-icon>
                </button>

                <!-- Preparing Actions -->
                <button *ngIf="order.status === 'PREPARING'"
                        class="btn-action btn-ready"
                        (click)="markReady(order.id)"
                        title="Mark Ready">
                  <mat-icon>done</mat-icon>
                </button>

                <!-- Ready for Pickup Actions -->
                <ng-container *ngIf="order.status === 'READY_FOR_PICKUP'">
                  <button *ngIf="order.deliveryType === 'SELF_PICKUP'"
                          class="btn-action btn-handover"
                          (click)="handoverSelfPickup(order.id)"
                          title="Handover">
                    <mat-icon>handshake</mat-icon>
                  </button>
                  <button *ngIf="order.deliveryType === 'HOME_DELIVERY' && order.assignedToDeliveryPartner"
                          class="btn-action btn-verify"
                          (click)="verifyPickupOTP(order.id)"
                          title="Verify OTP">
                    <mat-icon>pin</mat-icon>
                  </button>
                  <button *ngIf="order.deliveryType === 'HOME_DELIVERY' && !order.assignedToDeliveryPartner && !isSearchingDriver(order.id)"
                          class="btn-action btn-find-driver"
                          (click)="retryDriverSearch(order.id)"
                          title="Find Driver">
                    <mat-icon>person_search</mat-icon>
                  </button>
                  <mat-icon *ngIf="isSearchingDriver(order.id)" class="spin searching-icon">sync</mat-icon>
                </ng-container>

                <!-- Return Actions -->
                <button *ngIf="order.status === 'RETURNED_TO_SHOP'"
                        class="btn-action btn-collect"
                        (click)="confirmReturnReceipt(order.id)"
                        title="Collect Products">
                  <mat-icon>inventory</mat-icon>
                </button>

                <!-- Print Button -->
                <button class="btn-action btn-print" (click)="printOrderSmall(order.id)" title="Print Receipt">
                  <mat-icon>print</mat-icon>
                </button>

                <!-- View Details -->
                <button class="btn-details" (click)="showOrderDetailsModal(order)" title="View Details">
                  Details
                </button>
              </div>
            </td>
          </ng-container>
        </tr>

        <!-- Empty State -->
        <tr *ngIf="getPagedOrders().length === 0">
          <td colspan="6" class="empty-state">
            <div class="empty-content">
              <mat-icon>inbox</mat-icon>
              <div class="empty-title">No orders found</div>
              <div class="empty-subtitle" *ngIf="searchTerm || statusFilter !== 'ALL'">Try adjusting your search or filter</div>
              <div class="empty-subtitle" *ngIf="!searchTerm && statusFilter === 'ALL'">Orders will appear here when customers place them</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Infinite Scroll Info -->
  <div class="scroll-info" *ngIf="filteredOrders.length > 0">
    <span>Showing {{ getDisplayedOrdersCount() }} of {{ filteredOrders.length }} orders</span>
    <span *ngIf="isLoadingMore" class="loading-more">
      <mat-icon class="spin">sync</mat-icon> Loading more...
    </span>
  </div>

  <!-- Order Details Modal -->
  <div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <h3>Order #{{ selectedOrder?.orderNumber }}</h3>
          <span class="status-badge" [ngClass]="getStatusBadgeClass(selectedOrder?.status || '')">
            {{ getStatusLabel(selectedOrder?.status || '') }}
          </span>
        </div>
        <button class="modal-close" (click)="closeDetailsModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body" *ngIf="selectedOrder">
        <!-- Order Info -->
        <div class="detail-section">
          <h4>Order Information</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Order Date</span>
              <span class="detail-value">{{ selectedOrder.createdAt | date:'medium' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Payment Method</span>
              <span class="detail-value">{{ selectedOrder.paymentMethod === 'CASH_ON_DELIVERY' ? 'Cash on Delivery' : 'Online Payment' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Delivery Type</span>
              <span class="detail-value">{{ getDeliveryTypeLabel(selectedOrder) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Payment Status</span>
              <span class="detail-value">{{ selectedOrder.paymentStatus }}</span>
            </div>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="detail-section">
          <h4>Customer Information</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Name</span>
              <span class="detail-value">{{ selectedOrder.customerName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Phone</span>
              <span class="detail-value">{{ selectedOrder.customerPhone || 'Not provided' }}</span>
            </div>
            <div class="detail-item full-width" *ngIf="selectedOrder.customerAddress || selectedOrder.deliveryAddress">
              <span class="detail-label">Address</span>
              <span class="detail-value">{{ selectedOrder.customerAddress || selectedOrder.deliveryAddress }}</span>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="detail-section">
          <div class="items-header-row">
            <h4>Order Items ({{ selectedOrder.items?.length || 0 }})</h4>
            <button class="btn-add-item" (click)="toggleAddItemSearch()" *ngIf="!['CANCELLED', 'RETURNING_TO_SHOP', 'RETURNED_TO_SHOP'].includes(selectedOrder.status)">
              <mat-icon>{{ showAddItemSearch ? 'close' : 'add' }}</mat-icon>
              {{ showAddItemSearch ? 'Cancel' : 'Add Item' }}
            </button>
          </div>

          <!-- Add Item Search -->
          <div class="add-item-section" *ngIf="showAddItemSearch">
            <div class="add-item-search">
              <mat-icon class="search-icon">search</mat-icon>
              <input type="text"
                     [(ngModel)]="addItemSearchTerm"
                     (input)="searchProductsForOrder()"
                     placeholder="Search product by name..."
                     class="add-item-input"
                     autofocus>
            </div>
            <div class="add-item-results" *ngIf="addItemSearchResults.length > 0">
              <div class="add-item-result" *ngFor="let product of addItemSearchResults">
                <div class="result-info">
                  <span class="result-name">{{ product.name }}</span>
                  <span class="result-price">{{ product.price | currency:'INR':'symbol':'1.0-0' }}</span>
                </div>
                <div class="result-actions">
                  <input type="number"
                         class="result-qty-input"
                         [(ngModel)]="addItemQty"
                         min="1"
                         step="1"
                         (click)="$event.stopPropagation()">
                  <button class="btn-add-result" (click)="addItemToExistingOrder(product)" [disabled]="isAddingItem">
                    <mat-icon>add_shopping_cart</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            <div class="add-item-empty" *ngIf="addItemSearchTerm.length >= 2 && addItemSearchResults.length === 0 && !isSearchingProducts">
              No products found
            </div>
            <div class="add-item-loading" *ngIf="isSearchingProducts">
              Searching...
            </div>
          </div>

          <div class="items-list">
            <div class="item-row" *ngFor="let item of selectedOrder.items">
              <div class="item-image">
                <img *ngIf="item.image || item.productImageUrl"
                     [src]="getImageUrl(item.image || item.productImageUrl || '')"
                     [alt]="item.name || item.productName"
                     (error)="onImageError($event)">
                <div *ngIf="!item.image && !item.productImageUrl" class="item-placeholder">
                  {{ (item.name || item.productName || 'P')[0].toUpperCase() }}
                </div>
              </div>
              <div class="item-details">
                <div class="item-name">
                  {{ item.name || item.productName }}
                  <span class="added-badge" *ngIf="item.addedByShopOwner">Added</span>
                </div>
                <div class="item-calc">{{ item.quantity }} x {{ item.price || item.unitPrice | currency:'INR':'symbol':'1.0-0' }}</div>
              </div>
              <div class="item-total">{{ (item.quantity * (item.price || item.unitPrice)) | currency:'INR':'symbol':'1.0-0' }}</div>
            </div>
          </div>
          <div class="order-total">
            <span>Total</span>
            <span>{{ selectedOrder.totalAmount | currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer" *ngIf="selectedOrder">
        <button class="btn-modal btn-print-modal" (click)="printOrderSmall(selectedOrder.id)">
          <mat-icon>print</mat-icon>
          Print Receipt
        </button>

        <ng-container *ngIf="selectedOrder.status === 'PENDING'">
          <button class="btn-modal btn-accept-modal" (click)="acceptOrder(selectedOrder); closeDetailsModal()">
            <mat-icon>check</mat-icon>
            Accept Order
          </button>
          <button class="btn-modal btn-reject-modal" (click)="rejectOrder(selectedOrder); closeDetailsModal()">
            <mat-icon>close</mat-icon>
            Reject Order
          </button>
        </ng-container>

        <button *ngIf="selectedOrder.status === 'CONFIRMED'"
                class="btn-modal btn-action-modal"
                (click)="startPreparing(selectedOrder.id); closeDetailsModal()">
          <mat-icon>restaurant</mat-icon>
          Start Preparing
        </button>

        <button *ngIf="selectedOrder.status === 'PREPARING'"
                class="btn-modal btn-action-modal"
                (click)="markReady(selectedOrder.id); closeDetailsModal()">
          <mat-icon>done_all</mat-icon>
          Mark Ready
        </button>

        <button *ngIf="['CONFIRMED', 'PREPARING'].includes(selectedOrder.status)"
                class="btn-modal btn-cancel-modal"
                (click)="cancelOrder(selectedOrder); closeDetailsModal()">
          <mat-icon>cancel</mat-icon>
          Cancel Order
        </button>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="message success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="message error">{{ errorMessage }}</div>
</div>
