<div class="orders-page">
  <!-- Header -->
  <div class="page-header">
    <h1>Order Management</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="loadDashboardData()">
        Refresh Orders
      </button>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="quick-stats">
    <div class="stat">
      <span class="number">{{ totalOrders }}</span>
      <span class="label">Total</span>
    </div>
    <div class="stat">
      <span class="number">{{ pendingOrders.length }}</span>
      <span class="label">Pending</span>
    </div>
    <div class="stat">
      <span class="number">{{ activeOrders.length }}</span>
      <span class="label">Active</span>
    </div>
    <div class="stat">
      <span class="number">{{ completedOrders.length }}</span>
      <span class="label">Done</span>
    </div>
    <div class="stat">
      <span class="number">â‚¹{{ todayRevenue | number:'1.0-0' }}</span>
      <span class="label">Revenue</span>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input type="text"
           placeholder="Search orders..."
           [(ngModel)]="searchTerm"
           (input)="applyFilter()"
           class="search-input">

    <div class="date-filters">
      <input type="date"
             placeholder="From Date"
             [(ngModel)]="fromDate"
             (change)="applyFilter()"
             class="date-input">
      <span class="date-separator">to</span>
      <input type="date"
             placeholder="To Date"
             [(ngModel)]="toDate"
             (change)="applyFilter()"
             class="date-input">
      <button class="filter-btn" (click)="clearDateFilter()">Clear</button>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="status-tabs">
    <button class="tab-btn"
            [class.active]="selectedStatus === ''"
            (click)="selectStatusTab('')">
      All Orders ({{ totalOrders }})
    </button>
    <button class="tab-btn tab-pending"
            [class.active]="selectedStatus === 'PENDING'"
            (click)="selectStatusTab('PENDING')">
      Pending ({{ pendingOrders.length }})
    </button>
    <button class="tab-btn tab-confirmed"
            [class.active]="selectedStatus === 'CONFIRMED'"
            (click)="selectStatusTab('CONFIRMED')">
      Confirmed ({{ getOrdersByStatus('CONFIRMED').length }})
    </button>
    <button class="tab-btn tab-preparing"
            [class.active]="selectedStatus === 'PREPARING'"
            (click)="selectStatusTab('PREPARING')">
      Preparing ({{ getOrdersByStatus('PREPARING').length }})
    </button>
    <button class="tab-btn tab-ready"
            [class.active]="selectedStatus === 'READY_FOR_PICKUP'"
            (click)="selectStatusTab('READY_FOR_PICKUP')">
      Ready ({{ getOrdersByStatus('READY_FOR_PICKUP').length }})
    </button>
    <button class="tab-btn tab-delivered"
            [class.active]="selectedStatus === 'DELIVERED'"
            (click)="selectStatusTab('DELIVERED')">
      Delivered ({{ completedOrders.length }})
    </button>
  </div>

  <!-- Orders Cards Grid -->
  <div class="orders-grid">
    <div *ngFor="let order of filteredOrders" class="order-card" [ngClass]="'status-' + order.status.toLowerCase()">

      <!-- Card Header -->
      <div class="card-header">
        <div class="order-info">
          <div class="order-number">{{ order.orderNumber }}</div>
          <div class="order-time">{{ order.createdAt | date:'MMM d, HH:mm' }}</div>
        </div>
        <div class="header-actions">
          <button class="header-btn print-header-btn" (click)="printOrder(order.id)" title="Print Order">
            <span style="font-size: 12px;">Print</span>
          </button>
          <button class="header-btn details-header-btn" (click)="viewOrderDetails(order)" title="View Details">
            <span style="font-size: 12px;">View</span>
          </button>
          <div class="status-badge" [ngClass]="getStatusClass(order.status)">
            {{ getStatusLabel(order.status) }}
          </div>
        </div>
      </div>

      <!-- Customer Section -->
      <div class="customer-section">
        <div class="customer-avatar">
          <div class="avatar-circle">{{ (order.customerName || 'U')[0].toUpperCase() }}</div>
        </div>
        <div class="customer-details">
          <div class="customer-name">{{ order.customerName }}</div>
          <div class="customer-phone" *ngIf="order.customerPhone">Tel: {{ order.customerPhone }}</div>
        </div>
      </div>

      <!-- Pending Order Actions (Prominent) -->
      <div *ngIf="order.status === 'PENDING'" class="pending-actions-section">
        <div class="pending-alert">
          New order requires your attention
        </div>
        <div class="pending-buttons">
          <button class="pending-btn accept-pending-btn" (click)="acceptOrder(order)">
            Accept Order
          </button>
          <button class="pending-btn reject-pending-btn" (click)="rejectOrder(order)">
            Reject Order
          </button>
        </div>
      </div>

      <!-- Items Section -->
      <div class="items-section">
        <div class="items-header">
          <span class="items-label">Order Items ({{ order.items.length || 0 }})</span>
        </div>
        <div class="items-grid">
          <div *ngFor="let item of order.items" class="item-card">
            <div class="item-image-container">
              <div class="image-wrapper">
                <img *ngIf="item.image || item.productImageUrl"
                     [src]="getImageUrl((item.image || item.productImageUrl) || '')"
                     [alt]="item.name || item.productName"
                     class="item-image"
                     (error)="onImageError($event)">
                <div *ngIf="!item.image && !item.productImageUrl" class="item-icon" style="color: #6c757d; font-size: 20px; font-weight: bold;">
                  {{ (item.name || item.productName || 'P')[0].toUpperCase() }}
                </div>
              </div>
            </div>
            <div class="item-info">
              <div class="item-name">{{ item.name || item.productName }}</div>
              <div class="item-details">
                <span class="item-quantity-badge">{{ item.quantity }}</span>
                <span class="item-calculation">
                  {{ item.quantity }} Ã— â‚¹{{ item.price || item.unitPrice }} = â‚¹{{ (item.quantity * (item.price || item.unitPrice)) | number:'1.0-0' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Section -->
      <div class="total-section">
        <!-- Promo Code Info (if applied) -->
        <div class="promo-info" *ngIf="order.couponCode" style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #2196f3;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <i class="fas fa-tag" style="color: #2196f3; font-size: 16px;"></i>
            <strong style="color: #1976d2; font-size: 14px;">Platform Promo: {{ order.couponCode }}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 6px;">
            <span>Order Amount:</span>
            <span style="font-weight: 500;">â‚¹{{ (order.totalAmount + (order.discountAmount || 0)) | number:'1.0-0' }}</span>
          </div>
          <div style="background: #fff3e0; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ffb74d;">
            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
              <i class="fas fa-info-circle" style="color: #f57c00; font-size: 12px;"></i>
              <span style="font-size: 12px; color: #e65100; font-weight: 600;">Platform Discount:</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="font-size: 13px; color: #f57c00;">Discount Amount:</span>
              <span style="font-size: 14px; color: #f57c00; font-weight: bold;">- â‚¹{{ order.discountAmount | number:'1.0-0' }}</span>
            </div>
          </div>
          <div style="border-top: 2px solid #2196f3; padding-top: 8px; margin-top: 8px;">
            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="font-weight: bold; color: #2e7d32; font-size: 13px;">ðŸ’° Collect from Customer:</span>
                <span style="font-weight: bold; color: #2e7d32; font-size: 16px;">â‚¹{{ order.totalAmount | number:'1.0-0' }}</span>
              </div>
              <div style="font-size: 11px; color: #555; font-style: italic;">
                âœ“ You receive full â‚¹{{ (order.totalAmount + (order.discountAmount || 0)) | number:'1.0-0' }} (Platform covers â‚¹{{ order.discountAmount | number:'1.0-0' }})
              </div>
            </div>
          </div>
        </div>

        <!-- Regular Total (no promo) -->
        <div class="total-amount" *ngIf="!order.couponCode">
          <div class="total-label">Order Total</div>
          <div class="total-price">â‚¹{{ order.totalAmount | number:'1.0-0' }}</div>
        </div>

        <div class="payment-info">
          <span class="payment-text">{{ order.paymentMethod === 'CASH_ON_DELIVERY' ? 'Cash on Delivery' : 'Online Payment' }}</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card-actions">
        <!-- Pending Actions -->
        <ng-container *ngIf="order.status === 'PENDING'">
          <button class="action-btn accept-btn" (click)="acceptOrder(order)">
            Accept Order
          </button>
          <button class="action-btn reject-btn" (click)="rejectOrder(order)">
            Reject
          </button>
        </ng-container>

        <!-- Confirmed Actions -->
        <ng-container *ngIf="order.status === 'CONFIRMED'">
          <button class="action-btn prepare-btn" (click)="startPreparing(order.id)">
            Start Preparing
          </button>
        </ng-container>

        <!-- Preparing Actions -->
        <ng-container *ngIf="order.status === 'PREPARING'">
          <button class="action-btn ready-btn" (click)="markReady(order.id)">
            Mark Ready
          </button>
        </ng-container>

        <!-- Ready Actions -->
        <ng-container *ngIf="order.status === 'READY_FOR_PICKUP'">
          <button class="action-btn print-btn" (click)="printOrder(order.id)">
            Print Order
          </button>
          <button class="action-btn assign-btn" (click)="assignDelivery(order.id)">
            Assign Delivery
          </button>
        </ng-container>

        <!-- Details Button (Always Available) -->
        <button class="action-btn details-btn" (click)="viewOrderDetails(order)">
          View Details
        </button>

      </div>

    </div>

    <!-- Empty State -->
    <div *ngIf="filteredOrders.length === 0" class="empty-state">
      <div class="empty-icon" style="color: #6c757d; font-weight: 300; font-family: Arial;">[ ]</div>
      <div class="empty-title">No orders found</div>
      <div class="empty-subtitle" *ngIf="searchTerm">Try adjusting your search terms</div>
      <div class="empty-subtitle" *ngIf="!searchTerm">No orders in this status</div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="message success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="message error">{{ errorMessage }}</div>
</div>