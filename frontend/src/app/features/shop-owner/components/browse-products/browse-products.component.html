<div class="browse-products-container">
  <!-- Combined Filter Bar -->
  <mat-card class="filter-card">
    <div class="filter-controls">
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput
               [(ngModel)]="searchTerm"
               (ngModelChange)="onSearchChange()"
               placeholder="Search products...">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-select [(ngModel)]="selectedCategory" (selectionChange)="onCategorySelectChange($event.value)">
          <mat-option value="">All Categories</mat-option>
          <mat-option *ngFor="let category of categories" [value]="category">{{ category }}</mat-option>
          <mat-option value="__NEW__" class="add-new-category-option">
            <mat-icon>add</mat-icon> Add New Category
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-select [(ngModel)]="sortBy" (selectionChange)="onSortChange()">
          <mat-option value="name">A-Z</mat-option>
          <mat-option value="name-desc">Z-A</mat-option>
          <mat-option value="price-low">Price ↑</mat-option>
          <mat-option value="price-high">Price ↓</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="filter-chips">
        <mat-chip-listbox>
          <mat-chip-option (click)="filterByTag('featured')" [selected]="activeFilters.includes('featured')">
            <mat-icon>star</mat-icon> Featured
          </mat-chip-option>
          <mat-chip-option (click)="filterByTag('global')" [selected]="activeFilters.includes('global')">
            <mat-icon>public</mat-icon> Global
          </mat-chip-option>
          <mat-chip-option (click)="filterByTag('new')" [selected]="activeFilters.includes('new')">
            <mat-icon>fiber_new</mat-icon> New
          </mat-chip-option>
        </mat-chip-listbox>
      </div>

      <div class="select-all-control" *ngIf="filteredProducts.length > 0">
        <mat-checkbox
          [checked]="areAllProductsSelected()"
          (change)="areAllProductsSelected() ? clearSelection() : selectAllProducts()">
          Select All
        </mat-checkbox>
        <span class="selection-count" *ngIf="selectedProducts.length > 0">({{ selectedProducts.length }})</span>
      </div>
    </div>
  </mat-card>

  <!-- Bulk Actions Bar -->
  <div class="modern-header" *ngIf="selectedProducts.length > 0">
    <div class="header-actions">
      <button mat-stroked-button (click)="clearSelection()">
        <mat-icon>clear</mat-icon> Clear
      </button>
      <button mat-raised-button color="primary" (click)="assignSelectedProducts()" [disabled]="loading">
        <mat-icon>add_shopping_cart</mat-icon> Add {{ selectedProducts.length }} to Shop
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
    <h3>Loading products...</h3>
  </div>

  <!-- Products Grid -->
  <div class="modern-products-grid" *ngIf="!loading && filteredProducts.length > 0">
    <mat-card class="product-card"
              *ngFor="let product of filteredProducts; trackBy: trackByProductId"
              [class.selected]="isProductSelected(product)">

      <div class="product-image-container" (click)="toggleProductSelection(product)">
        <img [src]="product.primaryImageUrl || '/assets/images/product-placeholder.svg'"
             [alt]="product.name"
             loading="lazy"
             onerror="this.src='/assets/images/product-placeholder.svg'">

        <div class="selection-overlay">
          <mat-checkbox
            [checked]="isProductSelected(product)"
            (click)="$event.stopPropagation()"
            (change)="toggleProductSelection(product)">
          </mat-checkbox>
        </div>

        <div class="product-badges">
          <span class="badge featured" *ngIf="product.isFeatured"><mat-icon>star</mat-icon></span>
          <span class="badge global" *ngIf="product.isGlobal"><mat-icon>public</mat-icon></span>
          <span class="badge new" *ngIf="product.isNew"><mat-icon>fiber_new</mat-icon></span>
        </div>

        <div class="quick-actions">
          <button mat-mini-fab (click)="$event.stopPropagation(); openAssignmentDialog(product)">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>

      <mat-card-content>
        <div class="product-header">
          <h3 class="product-name">{{ product.name }}</h3>
        </div>

        <div class="product-info-grid">
          <div class="info-item" *ngIf="product.category?.name">
            <mat-icon>category</mat-icon>
            {{ product.category?.name }}
          </div>
          <div class="info-item" *ngIf="product.brand">
            <mat-icon>sell</mat-icon>
            {{ product.brand }}
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button mat-stroked-button
                (click)="toggleProductSelection(product)"
                [class.selected]="isProductSelected(product)">
          <mat-icon>{{ isProductSelected(product) ? 'check' : 'add' }}</mat-icon>
          {{ isProductSelected(product) ? 'Selected' : 'Select' }}
        </button>
        <button mat-raised-button color="primary" (click)="openAssignmentDialog(product)">
          <mat-icon>add</mat-icon> Add
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Pagination -->
  <mat-card class="pagination-card" *ngIf="!loading && totalProducts > pageSize">
    <mat-paginator
      [length]="totalProducts"
      [pageSize]="pageSize"
      [pageSizeOptions]="[12, 24, 48]"
      [pageIndex]="currentPage"
      [showFirstLastButtons]="true"
      (page)="onPageChange($event)">
    </mat-paginator>
  </mat-card>

  <!-- Empty State -->
  <mat-card class="empty-state-card" *ngIf="!loading && filteredProducts.length === 0">
    <div class="empty-illustration">
      <mat-icon>inventory_2</mat-icon>
    </div>
    <h2>No Products Found</h2>
    <p>Try adjusting your search or filters</p>
    <div class="empty-actions">
      <button mat-raised-button color="primary" (click)="clearFilters()">
        <mat-icon>refresh</mat-icon> Reset Filters
      </button>
    </div>
  </mat-card>
</div>
