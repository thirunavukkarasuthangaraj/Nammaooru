<div class="dialog-container">
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
      {{ isEditMode ? 'Edit Promo Code' : 'Create Promo Code' }}
    </h2>
    <button mat-icon-button mat-dialog-close>
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="promoForm">
      <!-- Basic Info Section -->
      <div class="form-section">
        <h3><mat-icon>info</mat-icon> Basic Information</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Promo Title *</mat-label>
          <input matInput formControlName="title" placeholder="e.g., Pongal Special Offer">
          <mat-error *ngIf="promoForm.get('title')?.hasError('required')">Title is required</mat-error>
        </mat-form-field>

        <div class="code-row">
          <mat-form-field appearance="outline" class="code-field">
            <mat-label>Promo Code *</mat-label>
            <input matInput formControlName="code" placeholder="e.g., PONGAL20" style="text-transform: uppercase;">
            <mat-hint>Only uppercase letters and numbers</mat-hint>
            <mat-error *ngIf="promoForm.get('code')?.hasError('required')">Code is required</mat-error>
            <mat-error *ngIf="promoForm.get('code')?.hasError('pattern')">Invalid characters</mat-error>
          </mat-form-field>
          <button mat-stroked-button type="button" (click)="generateCode()" class="generate-btn">
            <mat-icon>autorenew</mat-icon> Generate
          </button>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="2" placeholder="Describe this offer..."></textarea>
        </mat-form-field>
      </div>

      <!-- Discount Section -->
      <div class="form-section">
        <h3><mat-icon>percent</mat-icon> Discount Details</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Discount Type *</mat-label>
          <mat-select formControlName="type">
            <mat-option *ngFor="let type of promoTypes" [value]="type.value">
              {{ type.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="value-row" *ngIf="promoForm.get('type')?.value !== 'FREE_SHIPPING'">
          <mat-form-field appearance="outline">
            <mat-label>Discount Value *</mat-label>
            <span matPrefix *ngIf="promoForm.get('type')?.value === 'FIXED_AMOUNT'">₹&nbsp;</span>
            <input matInput type="number" formControlName="discountValue" min="1">
            <span matSuffix *ngIf="promoForm.get('type')?.value === 'PERCENTAGE'">%</span>
            <mat-error *ngIf="promoForm.get('discountValue')?.hasError('required')">Required</mat-error>
            <mat-error *ngIf="promoForm.get('discountValue')?.hasError('min')">Must be at least 1</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="promoForm.get('type')?.value === 'PERCENTAGE'">
            <mat-label>Max Discount</mat-label>
            <span matPrefix>₹&nbsp;</span>
            <input matInput type="number" formControlName="maximumDiscountAmount" min="0">
            <mat-hint>Optional cap</mat-hint>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Minimum Order Amount</mat-label>
          <span matPrefix>₹&nbsp;</span>
          <input matInput type="number" formControlName="minimumOrderAmount" min="0">
          <mat-hint>Leave 0 for no minimum</mat-hint>
        </mat-form-field>
      </div>

      <!-- Validity Section -->
      <div class="form-section">
        <h3><mat-icon>event</mat-icon> Validity Period</h3>

        <div class="date-row">
          <mat-form-field appearance="outline">
            <mat-label>Start Date *</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>End Date *</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <!-- Usage Limits Section -->
      <div class="form-section">
        <h3><mat-icon>group</mat-icon> Usage Limits</h3>

        <div class="limit-row">
          <mat-form-field appearance="outline">
            <mat-label>Total Usage Limit</mat-label>
            <input matInput type="number" formControlName="usageLimit" min="0">
            <mat-hint>Leave empty for unlimited</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Per Customer Limit</mat-label>
            <input matInput type="number" formControlName="usageLimitPerCustomer" min="1">
          </mat-form-field>
        </div>

        <div class="checkbox-row">
          <mat-checkbox formControlName="firstTimeOnly">
            <mat-icon>person_add</mat-icon>
            First-time customers only
          </mat-checkbox>
        </div>
      </div>

      <!-- Image Section -->
      <div class="form-section">
        <h3><mat-icon>image</mat-icon> Promo Banner (Optional)</h3>

        <div class="image-upload-area" *ngIf="!imagePreview">
          <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)" hidden>
          <div class="upload-placeholder" (click)="fileInput.click()">
            <mat-icon *ngIf="!isUploading">cloud_upload</mat-icon>
            <mat-spinner diameter="30" *ngIf="isUploading"></mat-spinner>
            <span *ngIf="!isUploading">Click to upload banner image</span>
            <span *ngIf="isUploading">Uploading...</span>
            <small>Recommended: 800x400px, Max 5MB</small>
          </div>
        </div>

        <div class="image-preview" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Promo banner preview" (error)="onImageError($event)">
          <button mat-icon-button color="warn" (click)="removeImage()" class="remove-image-btn">
            <mat-icon>delete</mat-icon>
          </button>
          <button mat-stroked-button color="warn" (click)="removeImage()" class="remove-image-text-btn">
            <mat-icon>delete</mat-icon> Remove Image
          </button>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()" [disabled]="isSaving">Cancel</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="isSaving">
      <mat-spinner diameter="20" *ngIf="isSaving"></mat-spinner>
      <span *ngIf="!isSaving">{{ isEditMode ? 'Update' : 'Create' }}</span>
    </button>
  </mat-dialog-actions>
</div>
