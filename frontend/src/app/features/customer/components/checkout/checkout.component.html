<div class="checkout-page" *ngIf="!orderPlaced">
  <!-- Page Header -->
  <mat-card class="page-header">
    <div class="header-container">
      <button mat-stroked-button color="primary" class="back-button" (click)="goBackToCart()">
        <mat-icon>arrow_back</mat-icon>
        Back to Cart
      </button>
      <div class="header-title">
        <mat-icon class="checkout-icon">payment</mat-icon>
        <h1>Checkout</h1>
      </div>
    </div>
  </mat-card>

  <!-- Main Content -->
  <div class="checkout-content">
    <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
      <div class="checkout-grid">
        
        <!-- Left Column: Form Fields -->
        <div class="form-column">
          
          <!-- Customer Information -->
          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>person</mat-icon>
                Customer Information
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>First Name</mat-label>
                  <input matInput formControlName="firstName" placeholder="Enter first name">
                  <mat-error *ngIf="checkoutForm.get('firstName')?.hasError('required')">
                    First name is required
                  </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Last Name</mat-label>
                  <input matInput formControlName="lastName" placeholder="Enter last name">
                  <mat-error *ngIf="checkoutForm.get('lastName')?.hasError('required')">
                    Last name is required
                  </mat-error>
                </mat-form-field>
              </div>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Phone Number</mat-label>
                  <mat-icon matPrefix>phone</mat-icon>
                  <input matInput formControlName="phone" placeholder="10-digit mobile number">
                  <mat-error *ngIf="checkoutForm.get('phone')?.hasError('required')">
                    Phone number is required
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('phone')?.hasError('pattern')">
                    Please enter a valid 10-digit number
                  </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Email</mat-label>
                  <mat-icon matPrefix>email</mat-icon>
                  <input matInput formControlName="email" placeholder="your@email.com">
                  <mat-error *ngIf="checkoutForm.get('email')?.hasError('required')">
                    Email is required
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('email')?.hasError('email')">
                    Please enter a valid email
                  </mat-error>
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Delivery Address -->
          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>location_on</mat-icon>
                Delivery Address
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Saved Addresses Selector -->
              <div class="saved-addresses-section" *ngIf="savedAddresses.length > 0">
                <h4>Select from saved addresses</h4>
                <div class="saved-addresses-list">
                  <mat-card *ngFor="let address of savedAddresses"
                            class="saved-address-card"
                            (click)="selectAddress(address)">
                    <mat-card-content>
                      <div class="address-type">
                        <mat-icon>{{ address.isDefault ? 'star' : 'location_on' }}</mat-icon>
                        <strong>{{address.contactName}}</strong>
                      </div>
                      <p class="address-text">{{address.address}}</p>
                      <p class="address-details">{{address.city}}, {{address.state}} - {{address.postalCode}}</p>
                      <p class="phone-number">{{address.phone}}</p>
                    </mat-card-content>
                  </mat-card>
                </div>
                <mat-divider></mat-divider>
                <p class="or-text">Or enter a new address below</p>
              </div>

              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Street Address</mat-label>
                <mat-icon matPrefix>home</mat-icon>
                <textarea matInput
                          formControlName="streetAddress"
                          placeholder="House no., Building, Street, Area"
                          rows="2"></textarea>
                <mat-error *ngIf="checkoutForm.get('streetAddress')?.hasError('required')">
                  Street address is required
                </mat-error>
              </mat-form-field>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Landmark</mat-label>
                  <mat-icon matPrefix>place</mat-icon>
                  <input matInput formControlName="landmark" placeholder="Near landmark">
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Pincode</mat-label>
                  <mat-icon matPrefix>pin_drop</mat-icon>
                  <input matInput formControlName="pincode" placeholder="6-digit pincode">
                  <mat-error *ngIf="checkoutForm.get('pincode')?.hasError('required')">
                    Pincode is required
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('pincode')?.hasError('pattern')">
                    Please enter a valid 6-digit pincode
                  </mat-error>
                </mat-form-field>
              </div>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>City</mat-label>
                  <mat-icon matPrefix>location_city</mat-icon>
                  <input matInput formControlName="city" placeholder="City name">
                  <mat-error *ngIf="checkoutForm.get('city')?.hasError('required')">
                    City is required
                  </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>State</mat-label>
                  <mat-icon matPrefix>map</mat-icon>
                  <input matInput formControlName="state" placeholder="State name">
                  <mat-error *ngIf="checkoutForm.get('state')?.hasError('required')">
                    State is required
                  </mat-error>
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Special Instructions -->
          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>notes</mat-icon>
                Special Instructions
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Delivery Instructions (Optional)</mat-label>
                <mat-icon matPrefix>edit_note</mat-icon>
                <textarea matInput 
                          formControlName="notes" 
                          placeholder="Any special delivery instructions, gate code, etc."
                          rows="3"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="summary-column">
          
          <!-- Order Summary Card -->
          <mat-card class="order-summary-card">
            <mat-card-header>
              <mat-card-title>Order Summary</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              
              <!-- Shop Info -->
              <div class="shop-info">
                <mat-icon>storefront</mat-icon>
                <div>
                  <span class="label">Ordering from</span>
                  <strong class="shop-name">{{cart.shopName || 'Test Grocery Store'}}</strong>
                </div>
              </div>

              <!-- Order Items -->
              <div class="order-items">
                <div class="item" *ngFor="let item of cart.items">
                  <div class="item-info">
                    <span class="item-name">{{item.productName}}</span>
                    <span class="item-quantity">{{item.quantity}} × ₹{{item.price}}</span>
                  </div>
                  <span class="item-total">₹{{item.price * item.quantity}}</span>
                </div>
              </div>

              <mat-divider></mat-divider>

              <!-- Price Breakdown -->
              <div class="price-breakdown">
                <div class="price-row">
                  <span>Items Subtotal:</span>
                  <span>₹{{cart.subtotal}}</span>
                </div>
                <div class="price-row">
                  <span>Delivery Fee:</span>
                  <span>₹{{cart.deliveryFee || 40}}</span>
                </div>
                <div class="price-row discount" *ngIf="cart.discount > 0">
                  <span>Discount:</span>
                  <span>-₹{{cart.discount}}</span>
                </div>
              </div>

              <mat-divider></mat-divider>

              <!-- Total -->
              <div class="total-section">
                <span class="total-label">Total Amount:</span>
                <span class="total-value">₹{{cart.total || (cart.subtotal + (cart.deliveryFee || 40))}}</span>
              </div>

              <!-- Payment Method -->
              <div class="payment-method">
                <mat-icon>payments</mat-icon>
                <div>
                  <strong>Payment Method</strong>
                  <p>Cash on Delivery</p>
                  <small>Pay ₹{{cart.total || (cart.subtotal + (cart.deliveryFee || 40))}} when your order is delivered</small>
                </div>
              </div>

              <!-- Terms -->
              <div class="terms-section">
                <mat-checkbox formControlName="agreeToTerms" color="primary">
                  I agree to the <a href="/terms" target="_blank">terms and conditions</a>
                </mat-checkbox>
                <mat-error *ngIf="checkoutForm.get('agreeToTerms')?.hasError('required') && checkoutForm.get('agreeToTerms')?.touched">
                  Please accept terms and conditions
                </mat-error>
              </div>

              <!-- Place Order Button -->
              <button mat-raised-button 
                      color="accent" 
                      type="button"
                      class="place-order-btn"
                      (click)="placeOrder()"
                      [disabled]="checkoutForm.invalid || placingOrder">
                <mat-icon *ngIf="!placingOrder">shopping_bag</mat-icon>
                <mat-spinner *ngIf="placingOrder" diameter="20"></mat-spinner>
                {{placingOrder ? 'Placing Order...' : 'Place Order'}}
              </button>
            </mat-card-content>
          </mat-card>

          <!-- Delivery Info Card -->
          <mat-card class="delivery-info-card">
            <mat-card-content>
              <div class="delivery-header">
                <mat-icon>local_shipping</mat-icon>
                <h4>Delivery Information</h4>
              </div>
              <div class="info-item">
                <mat-icon>schedule</mat-icon>
                <span>Estimated delivery in 30-45 minutes</span>
              </div>
              <div class="info-item">
                <mat-icon>verified_user</mat-icon>
                <span>Safe & contactless delivery</span>
              </div>
              <div class="info-item">
                <mat-icon>support_agent</mat-icon>
                <span>24/7 customer support</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Order Success Screen -->
<div class="order-success-page" *ngIf="orderPlaced">
  <mat-card class="success-card">
    <mat-card-content>
      <div class="success-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <h2>Order Placed Successfully!</h2>
      <p>Your order has been placed and will be delivered soon.</p>
      
      <div class="order-details">
        <div class="detail-item">
          <span class="label">Order Number</span>
          <span class="value">{{orderResponse?.orderNumber || 'ORD-2024-0001'}}</span>
        </div>
        <div class="detail-item">
          <span class="label">Total Amount</span>
          <span class="value">₹{{cart.total}}</span>
        </div>
        <div class="detail-item">
          <span class="label">Estimated Delivery</span>
          <span class="value">30-45 minutes</span>
        </div>
      </div>
      
      <div class="success-actions">
        <button mat-raised-button color="primary" (click)="trackOrder()">
          <mat-icon>local_shipping</mat-icon>
          Track Order
        </button>
        <button mat-stroked-button color="primary" (click)="continueShopping()">
          <mat-icon>store</mat-icon>
          Continue Shopping
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>