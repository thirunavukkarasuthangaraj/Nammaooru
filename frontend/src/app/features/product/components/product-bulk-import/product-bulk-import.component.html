<div class="bulk-import-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>cloud_upload</mat-icon>
        <span *ngIf="isSuperAdmin">Bulk Import Master Products</span>
        <span *ngIf="isShopOwner && !isSuperAdmin">Bulk Import Shop Products</span>
      </mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="isSuperAdmin">Import products to master catalog with images</span>
        <span *ngIf="isShopOwner && !isSuperAdmin">Import products to your shop</span>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Instructions Section -->
      <div class="instructions-section">
        <h3>
          <mat-icon>info</mat-icon>
          How to Import Products
        </h3>

        <div class="steps-container">
          <div class="step-card" *ngIf="isSuperAdmin">
            <div class="step-number">1</div>
            <div class="step-content">
              <h4><mat-icon>folder</mat-icon> Prepare Product Images</h4>
              <p>Upload your product images to the server's product images folder. Organize them in subfolders (e.g., vegetables, groceries, dairy).</p>
              <div class="info-box">
                <mat-icon>folder_open</mat-icon>
                <span>Contact system administrator for image upload access</span>
              </div>
            </div>
          </div>

          <div class="step-card">
            <div class="step-number" [innerHTML]="isSuperAdmin ? '2' : '1'"></div>
            <div class="step-content">
              <h4><mat-icon>download</mat-icon> Download Template</h4>
              <p>Download our pre-formatted Excel template with all required columns.</p>
              <button mat-raised-button color="primary" (click)="downloadSampleCSV()">
                <mat-icon>download</mat-icon>
                Download Sample Template
              </button>
            </div>
          </div>

          <div class="step-card">
            <div class="step-number" [innerHTML]="isSuperAdmin ? '3' : '2'"></div>
            <div class="step-content">
              <h4><mat-icon>edit</mat-icon> Fill Product Details</h4>
              <p>Open the template in Excel and fill in your product information. Required: <strong>name (A), category (D), imagePath (Y)</strong>. Categories are auto-created if not found.</p>
              <div class="info-box">
                <mat-icon>info</mat-icon>
                <span>Save as Excel Workbook (.xlsx) format</span>
              </div>
            </div>
          </div>

          <div class="step-card">
            <div class="step-number" [innerHTML]="isSuperAdmin ? '4' : '3'"></div>
            <div class="step-content">
              <h4><mat-icon>cloud_upload</mat-icon> Upload & Import</h4>
              <p>Select your completed Excel file below and click "Upload & Import" to process your products.</p>
            </div>
          </div>
        </div>

        <div class="alert alert-success">
          <mat-icon>lightbulb</mat-icon>
          <strong>Pro Tip:</strong> Start with a small batch of 2-3 products to verify everything works correctly!
        </div>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
        <div class="file-upload-area" *ngIf="!selectedFile">
          <input
            type="file"
            #fileInput
            accept=".xlsx,.xls"
            (change)="onFileSelected($event)"
            style="display: none"
          />

          <div class="upload-box" (click)="fileInput.click()">
            <mat-icon>upload_file</mat-icon>
            <p>Click to select Excel file (.xlsx)</p>
            <p class="hint">or drag and drop here</p>
          </div>
        </div>

        <div class="file-selected" *ngIf="selectedFile && !isUploading">
          <mat-icon class="file-icon">description</mat-icon>
          <div class="file-info">
            <h4>{{ selectedFile.name }}</h4>
            <p>{{ (selectedFile.size / 1024).toFixed(2) }} KB</p>
          </div>
          <button mat-icon-button color="warn" (click)="removeFile()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="upload-progress" *ngIf="isUploading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p>Uploading and processing... Please wait.</p>
        </div>

        <div class="upload-actions" *ngIf="selectedFile && !isUploading">
          <button
            mat-raised-button
            color="primary"
            (click)="uploadFile()"
            [disabled]="isUploading"
          >
            <mat-icon>cloud_upload</mat-icon>
            Upload & Import
          </button>

          <button mat-stroked-button (click)="removeFile()">
            <mat-icon>cancel</mat-icon>
            Cancel
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-section" *ngIf="showResults && importResults">
        <h3>
          <mat-icon>assessment</mat-icon>
          Import Results
        </h3>

        <div class="results-summary">
          <div class="summary-card total">
            <mat-icon>list</mat-icon>
            <div>
              <h4>{{ importResults.totalRows }}</h4>
              <p>Total Rows</p>
            </div>
          </div>

          <div class="summary-card success">
            <mat-icon>check_circle</mat-icon>
            <div>
              <h4>{{ importResults.successCount }}</h4>
              <p>Success</p>
            </div>
          </div>

          <div class="summary-card failed">
            <mat-icon>error</mat-icon>
            <div>
              <h4>{{ importResults.failureCount }}</h4>
              <p>Failed</p>
            </div>
          </div>
        </div>

        <div class="results-actions">
          <button mat-raised-button color="primary" (click)="resetUpload()">
            <mat-icon>add</mat-icon>
            Import More Products
          </button>

          <button mat-stroked-button (click)="exportResults()">
            <mat-icon>download</mat-icon>
            Export Results
          </button>
        </div>

        <!-- Detailed Results Table -->
        <div class="results-table">
          <table mat-table [dataSource]="importResults.results" class="full-width">
            <!-- Row Number Column -->
            <ng-container matColumnDef="rowNumber">
              <th mat-header-cell *matHeaderCellDef>Row</th>
              <td mat-cell *matCellDef="let result">{{ result.rowNumber }}</td>
            </ng-container>

            <!-- Product Name Column -->
            <ng-container matColumnDef="productName">
              <th mat-header-cell *matHeaderCellDef>Product Name</th>
              <td mat-cell *matCellDef="let result">{{ result.productName }}</td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let result">
                <span [class]="getStatusClass(result.status)" class="status-badge">
                  <mat-icon>{{ getStatusIcon(result.status) }}</mat-icon>
                  {{ result.status }}
                </span>
              </td>
            </ng-container>

            <!-- Message Column -->
            <ng-container matColumnDef="message">
              <th mat-header-cell *matHeaderCellDef>Message</th>
              <td mat-cell *matCellDef="let result">{{ result.message }}</td>
            </ng-container>

            <!-- Image Status Column -->
            <ng-container matColumnDef="imageStatus">
              <th mat-header-cell *matHeaderCellDef>Image Status</th>
              <td mat-cell *matCellDef="let result">
                {{ result.imageUploadStatus || 'N/A' }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </div>

      <!-- Help Section -->
      <div class="help-section">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>help</mat-icon>
              Need Help?
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="help-content">
            <h4><mat-icon>table_chart</mat-icon> Excel Template Columns (A-Z)</h4>
            <div class="columns-grid">
              <div class="column-item required">
                <strong>A: name</strong>
                <span>Product name (Required)</span>
              </div>
              <div class="column-item">
                <strong>B: nameTamil</strong>
                <span>Tamil name</span>
              </div>
              <div class="column-item">
                <strong>C: description</strong>
                <span>Product description</span>
              </div>
              <div class="column-item required">
                <strong>D: category</strong>
                <span>Category name (auto-created)</span>
              </div>
              <div class="column-item">
                <strong>E: brand</strong>
                <span>Brand name</span>
              </div>
              <div class="column-item">
                <strong>F: sku</strong>
                <span>SKU code</span>
              </div>
              <div class="column-item skip">
                <strong>G-H: (Skip)</strong>
                <span>Reserved columns</span>
              </div>
              <div class="column-item">
                <strong>I: baseUnit</strong>
                <span>Unit (kg, piece, gram)</span>
              </div>
              <div class="column-item">
                <strong>J: baseWeight</strong>
                <span>Weight value</span>
              </div>
              <div class="column-item">
                <strong>K: originalPrice</strong>
                <span>MRP/Original price</span>
              </div>
              <div class="column-item">
                <strong>L: sellingPrice</strong>
                <span>Selling price</span>
              </div>
              <div class="column-item">
                <strong>M: discountPct</strong>
                <span>Discount %</span>
              </div>
              <div class="column-item">
                <strong>N: costPrice</strong>
                <span>Cost price</span>
              </div>
              <div class="column-item">
                <strong>O: stockQuantity</strong>
                <span>Available stock</span>
              </div>
              <div class="column-item">
                <strong>P-Q: stockLevels</strong>
                <span>Min/Max stock levels</span>
              </div>
              <div class="column-item">
                <strong>R: trackInventory</strong>
                <span>TRUE/FALSE</span>
              </div>
              <div class="column-item">
                <strong>S: status</strong>
                <span>ACTIVE/INACTIVE</span>
              </div>
              <div class="column-item">
                <strong>T-U: flags</strong>
                <span>isFeatured, isAvailable</span>
              </div>
              <div class="column-item skip">
                <strong>V: (Skip)</strong>
                <span>Reserved</span>
              </div>
              <div class="column-item">
                <strong>W: tags</strong>
                <span>Comma-separated tags</span>
              </div>
              <div class="column-item">
                <strong>X: specifications</strong>
                <span>Product specs</span>
              </div>
              <div class="column-item required">
                <strong>Y: imagePath</strong>
                <span>Image filename (tomato.jpg)</span>
              </div>
              <div class="column-item">
                <strong>Z: imageFolder</strong>
                <span>Folder name (vegetables)</span>
              </div>
            </div>

            <div class="example-section">
              <h4><mat-icon>folder_special</mat-icon> Image Organization Example</h4>
              <div class="folder-structure">
                <div class="folder-item">
                  <mat-icon>folder</mat-icon>
                  <span>vegetables/</span>
                </div>
                <div class="file-items">
                  <div class="file-item">
                    <mat-icon>image</mat-icon>
                    <span>tomato.jpg</span>
                  </div>
                  <div class="file-item">
                    <mat-icon>image</mat-icon>
                    <span>onion.jpg</span>
                  </div>
                </div>

                <div class="folder-item">
                  <mat-icon>folder</mat-icon>
                  <span>groceries/</span>
                </div>
                <div class="file-items">
                  <div class="file-item">
                    <mat-icon>image</mat-icon>
                    <span>rice.jpg</span>
                  </div>
                  <div class="file-item">
                    <mat-icon>image</mat-icon>
                    <span>dal.jpg</span>
                  </div>
                </div>
              </div>
            </div>

            <h4><mat-icon>troubleshoot</mat-icon> Common Issues & Solutions</h4>
            <div class="issues-list">
              <div class="issue-item">
                <mat-icon color="warn">error</mat-icon>
                <div>
                  <strong>Invalid category ID</strong>
                  <p>Solution: Get valid category IDs from the Category Management section</p>
                </div>
              </div>
              <div class="issue-item">
                <mat-icon color="warn">broken_image</mat-icon>
                <div>
                  <strong>Image not found</strong>
                  <p>Solution: Ensure image filename matches exactly (case-sensitive) and file exists in specified folder</p>
                </div>
              </div>
              <div class="issue-item">
                <mat-icon color="warn">description</mat-icon>
                <div>
                  <strong>Wrong file format</strong>
                  <p>Solution: File must be .xlsx format (Excel 2007 or later)</p>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </div>
    </mat-card-content>
  </mat-card>
</div>
