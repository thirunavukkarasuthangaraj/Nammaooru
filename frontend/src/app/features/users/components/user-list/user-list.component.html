<div class="users-container">
  <div class="header-section">
    <div class="title-section">
      <h2>{{ getPageTitle() }}</h2>
      <button mat-raised-button color="primary" (click)="createUser()" class="create-btn">
        <mat-icon>add</mat-icon>
        Add New User
      </button>
    </div>
    
    <div class="filters-section">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search users</mat-label>
        <input matInput [(ngModel)]="searchText" (keyup)="applyFilter()" placeholder="Name, email, username...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="role-filter">
        <mat-label>Filter by Role</mat-label>
        <mat-select [(ngModel)]="roleFilter" (selectionChange)="applyFilter()">
          <mat-option *ngFor="let role of roleOptions" [value]="role.value">
            {{ role.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="status-filter">
        <mat-label>Filter by Status</mat-label>
        <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilter()">
          <mat-option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="clearFilters()" class="clear-btn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>
  </div>

  <div class="table-container">
    <mat-table [dataSource]="dataSource" matSort class="users-table">
      <!-- Full Name Column -->
      <ng-container matColumnDef="fullName">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Name</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="user-info">
            <div class="user-avatar">
              <mat-icon>person</mat-icon>
            </div>
            <div class="user-details">
              <span class="user-name">{{ user.fullName }}</span>
              <span class="username">@{{ user.username }}</span>
            </div>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Email</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="email-info">
            <span class="email">{{ user.email }}</span>
            <mat-icon class="verified-icon" color="primary" *ngIf="user.emailVerified" matTooltip="Email verified">verified</mat-icon>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Role Column -->
      <ng-container matColumnDef="role">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Role</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="role-container">
            <span [class]="'role-badge role-' + user.role.toLowerCase().replace('_', '-')">
              {{ getRoleDisplayName(user.role) }}
            </span>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Department Column -->
      <ng-container matColumnDef="department">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Department</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="department-info">
            <span class="department">{{ user.department || 'Not assigned' }}</span>
            <span class="designation" *ngIf="user.designation">{{ user.designation }}</span>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="status-container">
            <!-- Delivery Partner Status Indicators -->
            <div *ngIf="user.role === 'DELIVERY_PARTNER'; else generalStatus" class="delivery-status">
              <!-- Online/Offline Status -->
              <mat-chip
                [class]="'status-chip online-status-' + (user.isOnline ? 'online' : 'offline')"
                [matTooltip]="getOnlineStatusTooltip(user)">
                <mat-icon class="status-icon">
                  {{ user.isOnline ? 'wifi' : 'wifi_off' }}
                </mat-icon>
                <span class="status-text">{{ user.isOnline ? 'Online' : 'Offline' }}</span>
              </mat-chip>

              <!-- Ride Status for Online Partners -->
              <mat-chip *ngIf="user.isOnline"
                [class]="'status-chip ride-status-' + getRideStatusClass(user.rideStatus)"
                [matTooltip]="getRideStatusTooltip(user.rideStatus)">
                <mat-icon class="status-icon">{{ getRideStatusIcon(user.rideStatus) }}</mat-icon>
                <span class="status-text">{{ getRideStatusDisplay(user.rideStatus) }}</span>
              </mat-chip>
            </div>

            <!-- General User Status -->
            <ng-template #generalStatus>
              <mat-chip
                [class]="'status-chip status-' + (user.isActive ? 'active' : 'inactive')"
                [matTooltip]="getStatusTooltip(user)">
                <mat-icon class="status-icon">{{ getStatusIcon(user) }}</mat-icon>
                <span class="status-text">{{ getDisplayStatus(user) }}</span>
              </mat-chip>
            </ng-template>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Last Login Column -->
      <ng-container matColumnDef="lastLogin">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Last Login</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="last-login-container">
            <span class="last-login" *ngIf="user.lastLogin; else noLoginTemplate">
              {{ user.lastLogin | date:'dd/MM/yyyy HH:mm' }}
            </span>
            <ng-template #noLoginTemplate>
              <span class="no-login">Never logged in</span>
            </ng-template>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
        <mat-cell *matCellDef="let user">
          <div class="actions-container">
            <!-- Status Toggle -->
            <mat-slide-toggle 
              [checked]="user.isActive" 
              (change)="toggleUserStatus(user)"
              [matTooltip]="user.isActive ? 'User is Active - Click to Deactivate' : 'User is Inactive - Click to Activate'"
              [color]="user.isActive ? 'primary' : 'warn'"
              class="status-toggle">
            </mat-slide-toggle>
            
            <!-- Action buttons -->
            <div class="action-buttons">
              <button mat-icon-button 
                      (click)="viewUser(user)"
                      matTooltip="View Details"
                      color="primary"
                      class="action-btn view-btn">
                <mat-icon>visibility</mat-icon>
              </button>
              
              <button mat-icon-button 
                      (click)="editUser(user)"
                      matTooltip="Edit User"
                      color="accent"
                      class="action-btn edit-btn">
                <mat-icon>edit</mat-icon>
              </button>
              
              <!-- Document buttons for delivery partners - conditional based on document status -->
              <ng-container *ngIf="user.role === 'DELIVERY_PARTNER'">
                <!-- Show "View Documents" if documents exist -->
                <button *ngIf="hasDocuments(user.id)"
                        mat-raised-button
                        (click)="viewDocuments(user)"
                        matTooltip="View Uploaded Documents"
                        color="primary"
                        class="action-btn view-doc-btn"
                        style="margin-right: 4px; font-size: 11px;">
                  <mat-icon style="font-size: 16px;">folder_open</mat-icon>
                  View Docs
                </button>

                <!-- Show "Add Documents" if no documents exist -->
                <button *ngIf="!hasDocuments(user.id)"
                        mat-raised-button
                        (click)="addDocuments(user)"
                        matTooltip="Add Documents"
                        color="accent"
                        class="action-btn add-doc-btn"
                        style="margin-right: 4px; font-size: 11px;">
                  <mat-icon style="font-size: 16px;">add_circle</mat-icon>
                  Add Docs
                </button>
              </ng-container>

              <button mat-icon-button [matMenuTriggerFor]="menu"
                      matTooltip="More Actions"
                      class="action-btn more-btn">
                <mat-icon>more_vert</mat-icon>
              </button>
            </div>
            
            <mat-menu #menu="matMenu" class="user-actions-menu">
              <!-- Delivery Partner Document Management - conditional based on document status -->
              <ng-container *ngIf="user.role === 'DELIVERY_PARTNER'">
                <!-- If documents exist, show view and manage options -->
                <ng-container *ngIf="hasDocuments(user.id)">
                  <button mat-menu-item (click)="viewDocuments(user)" class="primary-menu-item">
                    <mat-icon color="primary">folder_open</mat-icon>
                    <span><strong>View Documents</strong></span>
                  </button>
                  <button mat-menu-item (click)="manageDocuments(user)">
                    <mat-icon color="accent">upload_file</mat-icon>
                    <span>Manage Documents</span>
                  </button>
                </ng-container>

                <!-- If no documents, show add option prominently -->
                <ng-container *ngIf="!hasDocuments(user.id)">
                  <button mat-menu-item (click)="addDocuments(user)" class="primary-menu-item">
                    <mat-icon color="accent">add_circle</mat-icon>
                    <span><strong>Add Documents</strong></span>
                  </button>
                  <button mat-menu-item (click)="manageDocuments(user)">
                    <mat-icon color="primary">upload_file</mat-icon>
                    <span>Upload Documents</span>
                  </button>
                </ng-container>
                <mat-divider></mat-divider>
              </ng-container>

              <button mat-menu-item (click)="resetPassword(user)">
                <mat-icon color="primary">lock_reset</mat-icon>
                <span>Reset Password</span>
              </button>

              <mat-divider></mat-divider>
              <button mat-menu-item (click)="deleteUser(user)" class="delete-action">
                <mat-icon color="warn">delete</mat-icon>
                <span>Delete User</span>
              </button>
            </mat-menu>
          </div>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;" class="user-row" (click)="viewUser(row)"></mat-row>
    </mat-table>

    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons></mat-paginator>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading users...</p>
  </div>

  <div *ngIf="!loading && dataSource.data.length === 0" class="no-data">
    <mat-icon>people_outline</mat-icon>
    <div class="no-data-content">
      <h3 *ngIf="originalData.length === 0; else filteredEmpty">No users in the system</h3>
      <ng-template #filteredEmpty>
        <h3>No users match your filters</h3>
      </ng-template>
      
      <p *ngIf="originalData.length === 0; else filteredMessage">
        Get started by adding your first user to the system.
      </p>
      <ng-template #filteredMessage>
        <p>Try adjusting your search terms or clearing the filters to see more results.</p>
      </ng-template>
      
      <div class="no-data-actions">
        <button *ngIf="originalData.length === 0" 
                mat-raised-button 
                color="primary" 
                (click)="createUser()"
                class="add-first-btn">
          <mat-icon>person_add</mat-icon>
          Add First User
        </button>
        
        <button *ngIf="originalData.length > 0" 
                mat-stroked-button 
                color="primary" 
                (click)="clearFilters()"
                class="clear-filters-btn">
          <mat-icon>clear_all</mat-icon>
          Clear Filters
        </button>
        
        <button *ngIf="originalData.length > 0" 
                mat-raised-button 
                color="primary" 
                (click)="createUser()"
                class="add-user-btn">
          <mat-icon>person_add</mat-icon>
          Add New User
        </button>
      </div>
    </div>
  </div>
</div>